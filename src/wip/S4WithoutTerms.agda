module S4WithoutTerms where

open import Prelude public


--------------------------------------------------------------------------------
--
-- Syntax


-- Type variables
data TVar : Set where
  tvar : String โ TVar

injtvar : โ {sโ sโ} โ tvar sโ โก tvar sโ โ sโ โก sโ
injtvar refl = refl

_โโแตฅ_ : (xโ xโ : TVar) โ Dec (xโ โก xโ)
tvar sโ โโแตฅ tvar sโ = mapDec (tvar &_) injtvar (sโ โโ sโ)

instance
  tvarIsString : IsString TVar
  tvarIsString =
    record
      { Constraint = ฮป s โ โค
      ; fromString = ฮป s โ tvar s
      }


-- Types
infixl 9 _โง_
infixr 7 _โ_
data Tp : Set where
  แตแต  : (x : TVar) โ Tp
  _โ_ : (A B : Tp) โ Tp
  _โง_ : (A B : Tp) โ Tp
  ๐ฏ   : Tp
  โก_  : (A : Tp) โ Tp

instance
  typeIsString : IsString Tp
  typeIsString =
    record
      { Constraint = ฮป s โ โค
      ; fromString = ฮป s โ แตแต (tvar s)
      }


-- Contexts
Cx : Set
Cx = Listยฒ Tp Tp


-- Syntactic entailment
infix 3 _โข_
data _โข_ : Cx โ Tp โ Set
  where
    แตแต  : โ {A ฮ ฮ} โ (i : ฮ โ A)
                    โ ฮ โ ฮ โข A

    แต   : โ {A ฮ ฮ} โ (i : ฮ โ A)
                    โ ฮ โ ฮ โข A

    ฦ   : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ , A โข B)
                      โ ฮ โ ฮ โข A โ B

    _$_ : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โข A โ B) (โฐ : ฮ โ ฮ โข A)
                      โ ฮ โ ฮ โข B

    _,_ : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โข A) (โฐ : ฮ โ ฮ โข B)
                      โ ฮ โ ฮ โข A โง B

    ฯโ  : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โข A โง B)
                      โ ฮ โ ฮ โข A

    ฯโ  : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โข A โง B)
                      โ ฮ โ ฮ โข B

    tt  : โ {ฮ ฮ} โ ฮ โ ฮ โข ๐ฏ

    โ_โ : โ {A ฮ ฮ} โ (๐ : ฮ โ โ โข A)
                    โ ฮ โ ฮ โข โก A

    โ_โ : โ {A C ฮ ฮ} โ (๐ : ฮ โ ฮ โข โก A) (โฐ : ฮ , A โ ฮ โข C)
                      โ ฮ โ ฮ โข C


-- Normal and neutral forms
mutual
  infix 3 _โขโโ_
  data _โขโโ_ : Cx โ Tp โ Set
    where
      ฦ   : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ , A โขโโ B)
                        โ ฮ โ ฮ โขโโ A โ B

      _,_ : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โขโโ A) (โฐ : ฮ โ ฮ โขโโ B)
                        โ ฮ โ ฮ โขโโ A โง B

      tt  : โ {ฮ ฮ} โ ฮ โ ฮ โขโโ ๐ฏ

      โ_โ : โ {A ฮ ฮ} โ (๐ : ฮ โ โ โข A)
                      โ ฮ โ ฮ โขโโ โก A

      โ_โ : โ {A C ฮ ฮ} โ (๐ : ฮ โ ฮ โขโโ โก A) (โฐ : ฮ , A โ ฮ โขโโ C)
                        โ ฮ โ ฮ โขโโ C

      โฟแต  : โ {x ฮ ฮ} โ (๐ : ฮ โ ฮ โขโโ แตแต x)
                      โ ฮ โ ฮ โขโโ แตแต x

  infix 3 _โขโโ_
  data _โขโโ_ : Cx โ Tp โ Set
    where
      แตแต  : โ {A ฮ ฮ} โ (i : ฮ โ A)
                      โ ฮ โ ฮ โขโโ A

      แต   : โ {A ฮ ฮ} โ (i : ฮ โ A)
                      โ ฮ โ ฮ โขโโ A

      _$_ : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โขโโ A โ B) (โฐ : ฮ โ ฮ โขโโ A)
                        โ ฮ โ ฮ โขโโ B

      ฯโ  : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โขโโ A โง B)
                        โ ฮ โ ฮ โขโโ A

      ฯโ  : โ {A B ฮ ฮ} โ (๐ : ฮ โ ฮ โขโโ A โง B)
                        โ ฮ โ ฮ โขโโ B


mutual
  embโโ : โ {ฮ ฮ A} โ ฮ โ ฮ โขโโ A โ ฮ โ ฮ โข A
  embโโ (ฦ ๐)     = ฦ (embโโ ๐)
  embโโ (๐ , โฐ)   = embโโ ๐ , embโโ โฐ
  embโโ tt        = tt
  embโโ (โ ๐ โ)   = โ ๐ โ
  embโโ (โ ๐ โ โฐ) = โ embโโ ๐ โ (embโโ โฐ)
  embโโ (โฟแต ๐)    = embโโ ๐

  embโโ : โ {ฮ ฮ A} โ ฮ โ ฮ โขโโ A โ ฮ โ ฮ โข A
  embโโ (แตแต i)  = แตแต i
  embโโ (แต i)   = แต i
  embโโ (๐ $ โฐ) = embโโ ๐ $ embโโ โฐ
  embโโ (ฯโ ๐)  = ฯโ (embโโ ๐)
  embโโ (ฯโ ๐)  = ฯโ (embโโ ๐)


--------------------------------------------------------------------------------
--
-- Renaming


แตren : โ {ฮ ฮโฒ ฮ A} โ ฮโฒ โ ฮ โ ฮ โ ฮ โข A
                    โ ฮโฒ โ ฮ โข A
แตren ฮท (แตแต i)    = แตแต (lookupแตฃ ฮท i)
แตren ฮท (แต i)     = แต i
แตren ฮท (ฦ ๐)     = ฦ (แตren ฮท ๐)
แตren ฮท (๐ $ โฐ)   = แตren ฮท ๐ $ แตren ฮท โฐ
แตren ฮท (๐ , โฐ)   = แตren ฮท ๐ , แตren ฮท โฐ
แตren ฮท (ฯโ ๐)    = ฯโ (แตren ฮท ๐)
แตren ฮท (ฯโ ๐)    = ฯโ (แตren ฮท ๐)
แตren ฮท tt        = tt
แตren ฮท (โ ๐ โ)   = โ แตren ฮท ๐ โ
แตren ฮท (โ ๐ โ โฐ) = โ แตren ฮท ๐ โ (แตren (lift ฮท) โฐ)

ren : โ {ฮ ฮ ฮโฒ A} โ ฮโฒ โ ฮ โ ฮ โ ฮ โข A
                   โ ฮ โ ฮโฒ โข A
ren ฮท (แตแต i)    = แตแต i
ren ฮท (แต i)     = แต (lookupแตฃ ฮท i)
ren ฮท (ฦ ๐)     = ฦ (ren (lift ฮท) ๐)
ren ฮท (๐ $ โฐ)   = ren ฮท ๐ $ ren ฮท โฐ
ren ฮท (๐ , โฐ)   = ren ฮท ๐ , ren ฮท โฐ
ren ฮท (ฯโ ๐)    = ฯโ (ren ฮท ๐)
ren ฮท (ฯโ ๐)    = ฯโ (ren ฮท ๐)
ren ฮท tt        = tt
ren ฮท (โ ๐ โ)   = โ ๐ โ
ren ฮท (โ ๐ โ โฐ) = โ ren ฮท ๐ โ (ren ฮท โฐ)


mutual
  แตrenโโ : โ {ฮ ฮโฒ ฮ A} โ ฮโฒ โ ฮ โ ฮ โ ฮ โขโโ A
                        โ ฮโฒ โ ฮ โขโโ A
  แตrenโโ ฮท (ฦ ๐)     = ฦ (แตrenโโ ฮท ๐)
  แตrenโโ ฮท (๐ , โฐ)   = แตrenโโ ฮท ๐ , แตrenโโ ฮท โฐ
  แตrenโโ ฮท tt        = tt
  แตrenโโ ฮท (โ ๐ โ)   = โ แตren ฮท ๐ โ
  แตrenโโ ฮท (โ ๐ โ โฐ) = โ แตrenโโ ฮท ๐ โ (แตrenโโ (lift ฮท) โฐ)
  แตrenโโ ฮท (โฟแต ๐)    = โฟแต (แตrenโโ ฮท ๐)

  แตrenโโ : โ {ฮ ฮโฒ ฮ A} โ ฮโฒ โ ฮ โ ฮ โ ฮ โขโโ A
                        โ ฮโฒ โ ฮ โขโโ A
  แตrenโโ ฮท (แตแต i)  = แตแต (lookupแตฃ ฮท i)
  แตrenโโ ฮท (แต i )  = แต i
  แตrenโโ ฮท (๐ $ โฐ) = แตrenโโ ฮท ๐ $ แตrenโโ ฮท โฐ
  แตrenโโ ฮท (ฯโ ๐)  = ฯโ (แตrenโโ ฮท ๐)
  แตrenโโ ฮท (ฯโ ๐)  = ฯโ (แตrenโโ ฮท ๐)


mutual
  renโโ : โ {ฮ ฮ ฮโฒ A} โ ฮโฒ โ ฮ โ ฮ โ ฮ โขโโ A
                       โ ฮ โ ฮโฒ โขโโ A
  renโโ ฮท (ฦ ๐)     = ฦ (renโโ (lift ฮท) ๐)
  renโโ ฮท (๐ , โฐ)   = renโโ ฮท ๐ , renโโ ฮท โฐ
  renโโ ฮท tt        = tt
  renโโ ฮท (โ ๐ โ)   = โ ๐ โ
  renโโ ฮท (โ ๐ โ โฐ) = โ renโโ ฮท ๐ โ (renโโ ฮท โฐ)
  renโโ ฮท (โฟแต ๐)    = โฟแต (renโโ ฮท ๐)

  renโโ : โ {ฮ ฮ ฮโฒ A} โ ฮโฒ โ ฮ โ ฮ โ ฮ โขโโ A
                       โ ฮ โ ฮโฒ โขโโ A
  renโโ ฮท (แตแต i)  = แตแต i
  renโโ ฮท (แต i)   = แต (lookupแตฃ ฮท i)
  renโโ ฮท (๐ $ โฐ) = renโโ ฮท ๐ $ renโโ ฮท โฐ
  renโโ ฮท (ฯโ ๐)  = ฯโ (renโโ ฮท ๐)
  renโโ ฮท (ฯโ ๐)  = ฯโ (renโโ ฮท ๐)


renโโยฒ : โ {ฮ ฮโฒ ฮ ฮโฒ A} โ ฮโฒ โ ฮโฒ โยฒ ฮ โ ฮ โ ฮ โ ฮ โขโโ A
                         โ ฮโฒ โ ฮโฒ โขโโ A
renโโยฒ ฮท ๐ = (แตrenโโ (projโ ฮท) โ renโโ (projโ ฮท)) ๐

renโโยฒ : โ {ฮ ฮโฒ ฮ ฮโฒ A} โ ฮโฒ โ ฮโฒ โยฒ ฮ โ ฮ โ ฮ โ ฮ โขโโ A
                         โ ฮโฒ โ ฮโฒ โขโโ A
renโโยฒ ฮท ๐ = (แตrenโโ (projโ ฮท) โ renโโ (projโ ฮท)) ๐


--------------------------------------------------------------------------------
--
-- Substitution


-- Simultaneous substitutions
infix 3 _โขโ_
_โขโ_ : Cx โ List Tp โ Set
ฮ โ ฮ โขโ ฮ = All (ฮ โ ฮ โข_) ฮ


แตrenโ : โ {ฮ ฮโฒ ฮ ฮ} โ ฮโฒ โ ฮ โ ฮ โ ฮ โขโ ฮ
                     โ ฮโฒ โ ฮ โขโ ฮ
แตrenโ ฮท ฯ = mapAll (แตren ฮท) ฯ

renโ : โ {ฮ ฮ ฮโฒ ฮ} โ ฮโฒ โ ฮ โ ฮ โ ฮ โขโ ฮ
                     โ ฮ โ ฮโฒ โขโ ฮ
renโ ฮท ฯ = mapAll (ren ฮท) ฯ


แตwkโ : โ {ฮ ฮ ฮ A} โ ฮ โ ฮ โขโ ฮ
                   โ ฮ , A โ ฮ โขโ ฮ
แตwkโ ฯ = แตrenโ (wk idแตฃ) ฯ

wkโ : โ {ฮ ฮ ฮ A} โ ฮ โ ฮ โขโ ฮ
                  โ ฮ โ ฮ , A โขโ ฮ
wkโ ฯ = renโ (wk idแตฃ) ฯ

แตliftโ : โ {ฮ ฮ ฮ A} โ ฮ โ ฮ โขโ ฮ
                     โ ฮ , A โ ฮ โขโ ฮ , A
แตliftโ ฯ = แตwkโ ฯ , แตแต zero

liftโ : โ {ฮ ฮ ฮ A} โ ฮ โ ฮ โขโ ฮ
                    โ ฮ โ ฮ , A โขโ ฮ , A
liftโ ฯ = wkโ ฯ , แต zero


แตidโ : โ {ฮ ฮ} โ ฮ โ ฮ โขโ ฮ
แตidโ {โ}     = โ
แตidโ {ฮ , A} = แตliftโ แตidโ

idโ : โ {ฮ ฮ} โ ฮ โ ฮ โขโ ฮ
idโ {โ}     = โ
idโ {ฮ , A} = liftโ idโ


lookupโ : โ {ฮ ฮ ฮ A} โ ฮ โ ฮ โขโ ฮ โ ฮ โ A
                      โ ฮ โ ฮ โข A
lookupโ ฯ i = lookupAll ฯ i


-- Substitution
แตsub : โ {ฮ ฮ ฮ A} โ ฮ โ โ โขโ ฮ โ ฮ โ ฮ โข A
                   โ ฮ โ ฮ โข A
แตsub ฯ (แตแต i)    = ren infแตฃ (lookupโ ฯ i)
แตsub ฯ (แต i)     = แต i
แตsub ฯ (ฦ ๐)     = ฦ (แตsub ฯ ๐)
แตsub ฯ (๐ $ โฐ)   = แตsub ฯ ๐ $ แตsub ฯ โฐ
แตsub ฮท (๐ , โฐ)   = แตsub ฮท ๐ , แตsub ฮท โฐ
แตsub ฮท (ฯโ ๐)    = ฯโ (แตsub ฮท ๐)
แตsub ฮท (ฯโ ๐)    = ฯโ (แตsub ฮท ๐)
แตsub ฮท tt        = tt
แตsub ฯ โ ๐ โ     = โ แตsub ฯ ๐ โ
แตsub ฯ (โ ๐ โ โฐ) = โ แตsub ฯ ๐ โ (แตsub (แตliftโ ฯ) โฐ)

sub : โ {ฮ ฮ ฮ A} โ ฮ โ ฮ โขโ ฮ โ ฮ โ ฮ โข A
                  โ ฮ โ ฮ โข A
sub ฯ (แตแต i)    = แตแต i
sub ฯ (แต i)     = lookupโ ฯ i
sub ฯ (ฦ ๐)     = ฦ (sub (liftโ ฯ) ๐)
sub ฯ (๐ $ โฐ)   = sub ฯ ๐ $ sub ฯ โฐ
sub ฮท (๐ , โฐ)   = sub ฮท ๐ , sub ฮท โฐ
sub ฮท (ฯโ ๐)    = ฯโ (sub ฮท ๐)
sub ฮท (ฯโ ๐)    = ฯโ (sub ฮท ๐)
sub ฮท tt        = tt
sub ฯ โ ๐ โ     = โ ๐ โ
sub ฯ (โ ๐ โ โฐ) = โ sub ฯ ๐ โ (sub (แตwkโ ฯ) โฐ)


--------------------------------------------------------------------------------
--
-- Semantics


-- Introspective Kripke models
record ๐ : Setโ where
  field
    ๐ฒ    : Set

    _๐ฑ_  : ๐ฒ โ TVar โ Set

    _โฅ_  : ๐ฒ โ ๐ฒ โ Set

    idโ  : โ {w} โ w โฅ w

    _โโ_ : โ {w wโฒ wโณ} โ wโฒ โฅ w โ wโณ โฅ wโฒ
                       โ wโณ โฅ w

    movแตฅ : โ {x w wโฒ} โ wโฒ โฅ w โ w ๐ฑ x
                      โ wโฒ ๐ฑ x

    โ_โ  : ๐ฒ โ Cx

    โ_โโ : โ {w wโฒ} โ wโฒ โฅ w
                    โ โ wโฒ โ โยฒ โ w โ

open ๐ {{โฆ}} public


แตโ_โ : โ {{๐ : ๐}} โ ๐ฒ โ List Tp
แตโ w โ = projโ โ w โ

แตโ_โโ : โ {{๐ : ๐}} {w wโฒ} โ wโฒ โฅ w
                           โ แตโ wโฒ โ โ แตโ w โ
แตโ ฮท โโ = projโ โ ฮท โโ


-- Values
mutual
  infix 3 _โฉ_
  _โฉ_ : โ {{๐ : ๐}} โ ๐ฒ โ Tp โ Set

  w โฉ แตแต x  = w ๐ฑ x

  w โฉ A โ B = โ {wโฒ} โ (ฮท : wโฒ โฅ w) (k : wโฒ แตโฉ A)
                      โ wโฒ แตโฉ B

  w โฉ A โง B = w แตโฉ A ร w แตโฉ B

  w โฉ ๐ฏ     = โค

  w โฉ โก A   = w แตแตโฉ A

  infix 3 _แตโฉ_
  _แตโฉ_ : โ {{๐ : ๐}} โ ๐ฒ โ Tp โ Set
  w แตโฉ A = โ {wโฒ C} โ (ฮท : wโฒ โฅ w) (f : โ {wโณ} โ wโณ โฅ wโฒ โ wโณ โฉ A
                                                 โ โ wโณ โ โขโโ C)
                     โ โ wโฒ โ โขโโ C

  infix 3 _แตแตโฉ_
  _แตแตโฉ_ : โ {{๐ : ๐}} โ ๐ฒ โ Tp โ Set
  w แตแตโฉ A = แตโ w โ โ โ โข A ร w แตโฉ A


syn : โ {{๐ : ๐}} {w A} โ w แตแตโฉ A
                        โ แตโ w โ โ โ โข A
syn p = projโ p

sem : โ {{๐ : ๐}} {w A} โ w แตแตโฉ A
                        โ w แตโฉ A
sem p = projโ p


-- Environments
infix 3 _แตโฉโ_
_แตโฉโ_ : โ {{๐ : ๐}} โ ๐ฒ โ List Tp โ Set
w แตโฉโ ฮ = All (w แตโฉ_) ฮ

infix 3 _แตแตโฉโ_
_แตแตโฉโ_ : โ {{๐ : ๐}} โ ๐ฒ โ List Tp โ Set
w แตแตโฉโ ฮ = All (w แตแตโฉ_) ฮ


synโ : โ {{๐ : ๐}} {w ฮ} โ w แตแตโฉโ ฮ
                         โ แตโ w โ โ โ โขโ ฮ
synโ ฮด = mapAll syn ฮด

semโ : โ {{๐ : ๐}} {w ฮ} โ w แตแตโฉโ ฮ
                         โ w แตโฉโ ฮ
semโ ฮด = mapAll sem ฮด


-- Semantic entailment
infix 3 _โจ_
_โจ_ : Cx โ Tp โ Setโ
ฮ โ ฮ โจ A = โ {{๐ : ๐}} {w} โ w แตแตโฉโ ฮ โ w แตโฉโ ฮ
                             โ w แตโฉ A


-- Accessibility
mutual
  mov : โ {{๐ : ๐}} {A w wโฒ} โ wโฒ โฅ w โ w โฉ A
                             โ wโฒ โฉ A
  mov {แตแต x}  ฮท ๐ = movแตฅ ฮท ๐
  mov {A โ B} ฮท f = ฮป ฮทโฒ โ f (ฮท โโ ฮทโฒ)
  mov {A โง B} ฮท p = แตmov {A} ฮท (projโ p) , แตmov {B} ฮท (projโ p)
  mov {๐ฏ}     ฮท t = tt
  mov {โก A}   ฮท p = แตแตmov ฮท p

  แตmov : โ {{๐ : ๐}} {A w wโฒ} โ wโฒ โฅ w โ w แตโฉ A
                              โ wโฒ แตโฉ A
  แตmov ฮท k = ฮป ฮทโฒ f โ k (ฮท โโ ฮทโฒ) f

  แตแตmov : โ {{๐ : ๐}} {A w wโฒ} โ wโฒ โฅ w โ w แตแตโฉ A
                               โ wโฒ แตแตโฉ A
  แตแตmov {A} ฮท (๐ , k) = แตren แตโ ฮท โโ ๐ , แตmov {A} ฮท k


แตmovโ : โ {{๐ : ๐}} {ฮ w wโฒ} โ wโฒ โฅ w โ w แตโฉโ ฮ
                             โ wโฒ แตโฉโ ฮ
-- TODO: Why does Agda require me to add seemingly unused annotations here?
-- แตmovโ ฮท ฮณ = mapAll (แตmov ฮท) ฮณ
แตmovโ ฮท ฮณ = mapAll (ฮป {A} k {_} {_} โ แตmov {A} ฮท (k {_})) ฮณ

แตแตmovโ : โ {{๐ : ๐}} {ฮ w wโฒ} โ wโฒ โฅ w โ w แตแตโฉโ ฮ
                              โ wโฒ แตแตโฉโ ฮ
แตแตmovโ ฮท ฮด = mapAll (แตแตmov ฮท) ฮด


-- Kripke continuation monad
return : โ {{๐ : ๐}} {A w} โ w โฉ A
                           โ w แตโฉ A
return {A} a = ฮป ฮท f โ
                 f idโ (mov {A} ฮท a)

bind : โ {{๐ : ๐}} {A C w} โ w แตโฉ A โ (โ {wโฒ} โ wโฒ โฅ w โ wโฒ โฉ A
                                                 โ wโฒ แตโฉ C)
                           โ w แตโฉ C
bind k f = ฮป ฮท fโฒ โ
             k ฮท (ฮป ฮทโฒ a โ
               f (ฮท โโ ฮทโฒ) a idโ (ฮป ฮทโณ b โ
                 fโฒ (ฮทโฒ โโ ฮทโณ) b))


lookupแตฅ : โ {{๐ : ๐}} {ฮ A w} โ w แตโฉโ ฮ โ ฮ โ A
                              โ w แตโฉ A
lookupแตฅ ฮณ i = lookupAll ฮณ i


-- Soundness
โ : โ {ฮ ฮ A} โ ฮ โ ฮ โข A
              โ ฮ โ ฮ โจ A
โ (แตแต i)            = ฮป ฮด ฮณ โ lookupแตฅ (semโ ฮด) i
โ (แต i)             = ฮป ฮด ฮณ โ lookupแตฅ ฮณ i
โ (ฦ {A} {B} ๐)     = ฮป ฮด ฮณ โ return {A โ B} (ฮป ฮท k โ
                        โ ๐ (แตแตmovโ ฮท ฮด) (แตmovโ ฮท ฮณ , k))
โ (_$_ {A} {B} ๐ โฐ) = ฮป ฮด ฮณ โ bind {A โ B} {B} (โ ๐ ฮด ฮณ) (ฮป ฮท f โ
                        f idโ (โ โฐ (แตแตmovโ ฮท ฮด) (แตmovโ ฮท ฮณ)))
โ (_,_ {A} {B} ๐ โฐ) = ฮป ฮด ฮณ โ return {A โง B} (โ ๐ ฮด ฮณ , โ โฐ ฮด ฮณ)
โ (ฯโ {A} {B} ๐)    = ฮป ฮด ฮณ โ bind {A โง B} {A} (โ ๐ ฮด ฮณ) (ฮป ฮท p โ
                        projโ p)
โ (ฯโ {A} {B} ๐)    = ฮป ฮด ฮณ โ bind {A โง B} {B} (โ ๐ ฮด ฮณ) (ฮป ฮท p โ
                        projโ p)
โ tt                = ฮป ฮด ฮณ โ return {๐ฏ} tt
โ (โ_โ {A} ๐)       = ฮป ฮด ฮณ โ return {โก A} (แตsub (synโ ฮด) ๐ , โ ๐ ฮด โ)
โ (โ_โ {A} {C} ๐ โฐ) = ฮป ฮด ฮณ โ bind {โก A} {C} (โ ๐ ฮด ฮณ) (ฮป ฮท p โ
                        โ โฐ (แตแตmovโ ฮท ฮด , p) (แตmovโ ฮท ฮณ))


--------------------------------------------------------------------------------
--
-- Completeness


-- Universal model
instance
  ๐แตค : ๐
  ๐แตค = record
         { ๐ฒ    = Cx
         ; _๐ฑ_  = _๐ฑแตค_
         ; _โฅ_  = _โยฒ_
         ; idโ  = idแตฃยฒ
         ; _โโ_ = _โแตฃยฒ_
         ; movแตฅ = renโโยฒ
         ; โ_โ  = id
         ; โ_โโ = id
         }
    where
      infix 3 _๐ฑแตค_
      _๐ฑแตค_ : Cx โ TVar โ Set
      ฮ โ ฮ ๐ฑแตค x = ฮ โ ฮ โขโโ แตแต x


-- Soundness and completeness with respect to the universal model
mutual
  โแตค : โ {A ฮ ฮ} โ ฮ โ ฮ โขโโ A
                 โ ฮ โ ฮ แตโฉ A
  โแตค {แตแต x}  ๐ = return {แตแต x} (โฟแต ๐)
  โแตค {A โ B} ๐ = return {A โ B} (ฮป ฮท k โ โแตค (renโโยฒ ฮท ๐ $ โแตค k))
  โแตค {A โง B} ๐ = return {A โง B} (โแตค (ฯโ ๐) , โแตค (ฯโ ๐))
  โแตค {๐ฏ}     ๐ = return {๐ฏ} tt
  โแตค {โก A}   ๐ = ฮป ฮท f โ โ renโโยฒ ฮท ๐ โ (f (แตwkยฒ idแตฃยฒ) (แตแต zero , โแตค (แตแต zero)))

  โแตค : โ {A ฮ ฮ} โ ฮ โ ฮ แตโฉ A
                 โ ฮ โ ฮ โขโโ A
  โแตค {แตแต x}  k = k idแตฃยฒ (ฮป ฮท ๐ โ ๐)
  โแตค {A โ B} k = k idแตฃยฒ (ฮป ฮท f โ ฦ (โแตค (f (wkยฒ idแตฃยฒ) (โแตค (แต zero)))))
  โแตค {A โง B} k = k idแตฃยฒ (ฮป ฮท p โ โแตค (projโ p) , โแตค (projโ p))
  โแตค {๐ฏ}     k = k idแตฃยฒ (ฮป ฮท t โ tt)
  โแตค {โก A}   k = k idแตฃยฒ (ฮป ฮท p โ โ syn p โ)


แตidแตฅ : โ {ฮ ฮ} โ ฮ โ ฮ แตแตโฉโ ฮ
แตidแตฅ {โ}     = โ
แตidแตฅ {ฮ , A} = แตแตmovโ (แตwkยฒ idแตฃยฒ) แตidแตฅ , (แตแต zero , โแตค (แตแต zero))

idแตฅ : โ {ฮ ฮ} โ ฮ โ ฮ แตโฉโ ฮ
idแตฅ {โ}     = โ
idแตฅ {ฮ , A} = แตmovโ (wkยฒ idแตฃยฒ) idแตฅ , โแตค (แต zero)


-- Completeness
โ : โ {ฮ ฮ A} โ ฮ โ ฮ โจ A
              โ ฮ โ ฮ โขโโ A
โ f = โแตค (f แตidแตฅ idแตฅ)


-- Normalisation
nm : โ {ฮ ฮ A} โ ฮ โ ฮ โข A
               โ ฮ โ ฮ โขโโ A
nm = โ โ โ


--------------------------------------------------------------------------------
--
-- Examples


แตแต0 : โ {ฮ ฮ A} โ ฮ , A โ ฮ โข A
แตแต0 = แตแต zero

แตแต1 : โ {ฮ ฮ A B} โ ฮ , A , B โ ฮ โข A
แตแต1 = แตแต (suc zero)

แตแต2 : โ {ฮ ฮ A B C} โ ฮ , A , B , C โ ฮ โข A
แตแต2 = แตแต (suc (suc zero))


แต0 : โ {ฮ ฮ A} โ ฮ โ ฮ , A โข A
แต0 = แต zero

แต1 : โ {ฮ ฮ A B} โ ฮ โ ฮ , A , B โข A
แต1 = แต (suc zero)

แต2 : โ {ฮ ฮ A B C} โ ฮ โ ฮ , A , B , C โข A
แต2 = แต (suc (suc zero))


แตหฃI : โ {A ฮ ฮ} โ ฮ โ ฮ โข A โ A
แตหฃI = ฦ แต0

แตหฃK : โ {A B ฮ ฮ} โ ฮ โ ฮ โข A โ B โ A
แตหฃK = ฦ (ฦ แต1)

แตหฃS : โ {A B C ฮ ฮ} โ ฮ โ ฮ โข (A โ B โ C) โ (A โ B) โ A โ C
แตหฃS = ฦ (ฦ (ฦ ((แต2 $ แต0) $ (แต1 $ แต0))))


แตหฃD : โ {A B ฮ ฮ} โ ฮ โ ฮ โข โก (A โ B) โ โก A โ โก B
แตหฃD = ฦ (ฦ (โ แต1 โ (โ แต0 โ โ แตแต1 $ แตแต0 โ)))

แตหฃT : โ {A ฮ ฮ} โ ฮ โ ฮ โข โก A โ A
แตหฃT = ฦ (โ แต0 โ แตแต0)

แตหฃ4 : โ {A ฮ ฮ} โ ฮ โ ฮ โข โก A โ โก โก A
แตหฃ4 = ฦ (โ แต0 โ โ โ แตแต0 โ โ)


--------------------------------------------------------------------------------
--
-- Conversion tests


testโผ : โ {ฮ ฮ A} โ ฮ โ ฮ โข A โ ฮ โ ฮ โข A โ Set
testโผ ๐โ ๐โ = embโโ (nm ๐โ) โก ๐โ


-- redโ : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ , A โข B) (โฐ : ฮ โ ฮ โข A)
--                    โ ฦ ๐ $ โฐ โผ sub (idโ , โฐ) ๐

testโผredโ : testโผ {โ} {โ , "A"}
                  ((ฦ แต0) $ แต0)
                  แต0
testโผredโ = refl


-- redโงโ : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ โข A) (โฐ : ฮ โ ฮ โข B)
--                     โ ฯโ (๐ , โฐ) โผ ๐

testโผredโงโ : testโผ {โ} {โ , "A" , "B"}
                   (ฯโ (แต1 , แต0))
                   แต1
testโผredโงโ = refl


-- redโงโ : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ โข A) (โฐ : ฮ โ ฮ โข B)
--                     โ ฯโ (๐ , โฐ) โผ โฐ

testโผredโงโ : testโผ {โ} {โ , "A" , "B"}
                   (ฯโ (แต1 , แต0))
                   แต0
testโผredโงโ = refl


-- redโก : โ {ฮ ฮ A C} โ (๐ : ฮ โ โ โข A) (โฐ : ฮ , A โ ฮ โข C)
--                    โ โ โ ๐ โ โ โฐ โผ แตsub (แตidโ , ๐) โฐ

testโผredโก : testโผ {โ , "A"} {โ}
                  (โ โ แตแต0 โ โ แตแต0)
                  แตแต0
testโผredโก = refl


-- expโ : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ โข A โ B)
--                    โ ๐ โผ ฦ (ren (wk idแตฃ) ๐ $ แต0)

testโผexpโ : testโผ {โ} {โ , "A" โ "B"}
                  แต0
                  (ฦ (ren (wk idแตฃ) แต0 $ แต0))
testโผexpโ = refl


-- expโง : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ โข A โง B)
--                    โ ๐ โผ ฯโ ๐ , ฯโ ๐

testโผexpโง : testโผ {โ} {โ , "A" โง "B"}
                  แต0
                  (ฯโ แต0 , ฯโ แต0)
testโผexpโง = refl


-- exp๐ฏ : โ {ฮ ฮ} โ (๐ : ฮ โ ฮ โข ๐ฏ)
--                โ ๐ โผ tt

testโผexp๐ฏ : testโผ {โ} {โ , ๐ฏ}
                  แต0
                  tt
testโผexp๐ฏ = refl


-- expโก : โ {ฮ ฮ} โ (๐ : ฮ โ ฮ โข โก A)
--                โ ๐ โผ โ ๐ โ โ แตแต0 โ

testโผexpโก : testโผ {โ} {โ , โก "A"}
                  แต0
                  (โ แต0 โ โ แตแต0 โ)
testโผexpโก = refl


-- commโก$ : โ {ฮ ฮ A B} โ (๐ฌ : ฮ โ ฮ โข โก (A โ B))
--                         (๐ : ฮ , A โ B โ ฮ โข A โ B) (โฐ : ฮ โ ฮ โข A)
--                      โ (โ ๐ฌ โ ๐) $ โฐ โผ โ ๐ฌ โ (๐ $ (แตren (wk idแตฃ) โฐ))

testโผcommโก$ : testโผ {โ} {โ , โก ("A" โ "B") , "A"}
                    ((โ แต1 โ แตแต0) $ แต0)
                    (โ แต1 โ (แตแต0 $ แตren (wk idแตฃ) แต0))
testโผcommโก$ = refl


-- commโกโโ : โ {ฮ ฮ A C} โ (๐ฌ : ฮ โ ฮ โข โก โก A)
--                          (๐ : ฮ , โก A โ ฮ โข โก A) (โฐ : ฮ , A โ ฮ โข C)
--                       โ โ (โ ๐ฌ โ ๐) โ โฐ โผ โ ๐ฌ โ (โ ๐ โ (แตren (wk idแตฃ) โฐ))

testโผcommโกโโ : testโผ {โ} {โ , โก โก "A"}
                     (โ โ แต0 โ แตแต0 โ แตแต0)
                     (โ แต0 โ (โ แตแต0 โ แตแต0))
testโผcommโกโโ = refl


-- commโกฯโ : โ {ฮ ฮ A B} โ (๐ฌ : ฮ โ ฮ โข โก (A โง B))
--                          (๐ : ฮ , A โง B โ ฮ โข A โง B)
--                       โ ฯโ (โ ๐ฌ โ ๐) โผ โ ๐ฌ โ (ฯโ ๐)

testโผcommโกฯโ : testโผ {โ} {โ , โก ("A" โง "B")}
                     (ฯโ (โ แต0 โ แตแต0))
                     (โ แต0 โ (ฯโ แตแต0))
testโผcommโกฯโ = refl


-- commโกฯโ : โ {ฮ ฮ A B} โ (๐ฌ : ฮ โ ฮ โข โก (A โง B))
--                          (๐ : ฮ , A โง B โ ฮ โข A โง B)
--                       โ ฯโ (โ ๐ฌ โ ๐) โผ โ ๐ฌ โ (ฯโ ๐)

testโผcommโกฯโ : testโผ {โ} {โ , โก ("A" โง "B")}
                     (ฯโ (โ แต0 โ แตแต0))
                     (โ แต0 โ (ฯโ แตแต0))
testโผcommโกฯโ = refl


--------------------------------------------------------------------------------
--
-- Self-interpretation


-- weakBP : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ โข A)
--                      โ ๐ฏ $ โ ๐ โ โผ โ ๐ โ

testโผweakBP : testโผ {โ , "A"} {โ}
                    (แตหฃT $ โ แตแต0 โ)
                    แตแต0
testโผweakBP = refl


-- Andrej : โ {ฮ ฮ A B} โ (๐ : ฮ โ ฮ โข A โ B) (โฐ : ฮ โ ฮ โข A)
--                      โ (๐ป $ โ ๐ โ) $ โ โฐ โ โผ โ ๐ $ โฐ โ

testโผAndrej : testโผ {โ , "A" โ "B" , "A"} {โ}
                    ((แตหฃD $ โ แตแต1 โ) $ โ แตแต0 โ)
                    (โ แตแต1 $ แตแต0 โ)
testโผAndrej = refl


--------------------------------------------------------------------------------

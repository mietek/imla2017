module S4InPaper where

open import Prelude public


--------------------------------------------------------------------------------
--
-- Syntax


-- Types
infixr 7 _âŠƒ_
data Tp : Set where
  â™­   : Tp
  _âŠƒ_ : Tp â†’ Tp â†’ Tp
  â–¡_  : Tp â†’ Tp


-- Contexts
Cx : Set
Cx = ListÂ² Tp Tp


-- Syntactic entailment
infix 3 _âŠ¢_
data _âŠ¢_ : Cx â†’ Tp â†’ Set
  where
    áµáµ›  : âˆ€ {A Î” Î“} â†’ Î” âˆ‹ A
                    â†’ Î” â Î“ âŠ¢ A

    áµ›   : âˆ€ {A Î” Î“} â†’ Î“ âˆ‹ A
                    â†’ Î” â Î“ âŠ¢ A

    Æ›   : âˆ€ {A B Î” Î“} â†’ Î” â Î“ , A âŠ¢ B
                      â†’ Î” â Î“ âŠ¢ A âŠƒ B

    _$_ : âˆ€ {A B Î” Î“} â†’ Î” â Î“ âŠ¢ A âŠƒ B â†’ Î” â Î“ âŠ¢ A
                      â†’ Î” â Î“ âŠ¢ B

    âŒœ_âŒ : âˆ€ {A Î” Î“} â†’ Î” â âˆ… âŠ¢ A
                    â†’ Î” â Î“ âŠ¢ â–¡ A

    âŒ_âŒŸ : âˆ€ {A C Î” Î“} â†’ Î” â Î“ âŠ¢ â–¡ A â†’ Î” , A â Î“ âŠ¢ C
                      â†’ Î” â Î“ âŠ¢ C


-- Normal and neutral forms
mutual
  infix 3 _âŠ¢â‚™_
  data _âŠ¢â‚™_ : Cx â†’ Tp â†’ Set
    where
      Æ›   : âˆ€ {A B Î” Î“} â†’ Î” â Î“ , A âŠ¢â‚™ B
                        â†’ Î” â Î“ âŠ¢â‚™ A âŠƒ B

      âŒœ_âŒ : âˆ€ {A Î” Î“} â†’ Î” â âˆ… âŠ¢ A
                      â†’ Î” â Î“ âŠ¢â‚™ â–¡ A

      âŒ_âŒŸ : âˆ€ {A C Î” Î“} â†’ Î” â Î“ âŠ¢â‚™â‚‘ â–¡ A â†’ Î” , A â Î“ âŠ¢â‚™ C
                        â†’ Î” â Î“ âŠ¢â‚™ C

      â¿áµ‰  : âˆ€ {Î” Î“} â†’ Î” â Î“ âŠ¢â‚™â‚‘ â™­
                    â†’ Î” â Î“ âŠ¢â‚™ â™­

  infix 3 _âŠ¢â‚™â‚‘_
  data _âŠ¢â‚™â‚‘_ : Cx â†’ Tp â†’ Set
    where
      áµáµ›  : âˆ€ {A Î” Î“} â†’ Î” âˆ‹ A
                      â†’ Î” â Î“ âŠ¢â‚™â‚‘ A

      áµ›   : âˆ€ {A Î” Î“} â†’ Î“ âˆ‹ A
                      â†’ Î” â Î“ âŠ¢â‚™â‚‘ A

      _$_ : âˆ€ {A B Î” Î“} â†’ Î” â Î“ âŠ¢â‚™â‚‘ A âŠƒ B â†’ Î” â Î“ âŠ¢â‚™ A
                        â†’ Î” â Î“ âŠ¢â‚™â‚‘ B


mutual
  embâ‚™ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢â‚™ A â†’ Î” â Î“ âŠ¢ A
  embâ‚™ (Æ› M)     = Æ› (embâ‚™ M)
  embâ‚™ (âŒœ M âŒ)   = âŒœ M âŒ
  embâ‚™ (âŒ M âŒŸ N) = âŒ embâ‚™â‚‘ M âŒŸ (embâ‚™ N)
  embâ‚™ (â¿áµ‰ M)    = embâ‚™â‚‘ M

  embâ‚™â‚‘ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢â‚™â‚‘ A â†’ Î” â Î“ âŠ¢ A
  embâ‚™â‚‘ (áµáµ› i)  = áµáµ› i
  embâ‚™â‚‘ (áµ› i)   = áµ› i
  embâ‚™â‚‘ (M $ N) = embâ‚™â‚‘ M $ embâ‚™ N


--------------------------------------------------------------------------------
--
-- Renaming


áµren : âˆ€ {Î” Î”â€² Î“ A} â†’ Î”â€² âŠ‡ Î” â†’ Î” â Î“ âŠ¢ A
                    â†’ Î”â€² â Î“ âŠ¢ A
áµren Î· (áµáµ› i)    = áµáµ› (renáµ¢ Î· i)
áµren Î· (áµ› i)     = áµ› i
áµren Î· (Æ› M)     = Æ› (áµren Î· M)
áµren Î· (M $ N)   = áµren Î· M $ áµren Î· N
áµren Î· (âŒœ M âŒ)   = âŒœ áµren Î· M âŒ
áµren Î· (âŒ M âŒŸ N) = âŒ áµren Î· M âŒŸ (áµren (keep Î·) N)

ren : âˆ€ {Î” Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î” â Î“ âŠ¢ A
                   â†’ Î” â Î“â€² âŠ¢ A
ren Î· (áµáµ› i)    = áµáµ› i
ren Î· (áµ› i)     = áµ› (renáµ¢ Î· i)
ren Î· (Æ› M)     = Æ› (ren (keep Î·) M)
ren Î· (M $ N)   = ren Î· M $ ren Î· N
ren Î· (âŒœ M âŒ)   = âŒœ M âŒ
ren Î· (âŒ M âŒŸ N) = âŒ ren Î· M âŒŸ (ren Î· N)


mutual
  áµrenâ‚™ : âˆ€ {Î” Î”â€² Î“ A} â†’ Î”â€² âŠ‡ Î” â†’ Î” â Î“ âŠ¢â‚™ A
                       â†’ Î”â€² â Î“ âŠ¢â‚™ A
  áµrenâ‚™ Î· (Æ› M)     = Æ› (áµrenâ‚™ Î· M)
  áµrenâ‚™ Î· (âŒœ M âŒ)   = âŒœ áµren Î· M âŒ
  áµrenâ‚™ Î· (âŒ M âŒŸ N) = âŒ áµrenâ‚™â‚‘ Î· M âŒŸ (áµrenâ‚™ (keep Î·) N)
  áµrenâ‚™ Î· (â¿áµ‰ M)    = â¿áµ‰ (áµrenâ‚™â‚‘ Î· M)

  áµrenâ‚™â‚‘ : âˆ€ {Î” Î”â€² Î“ A} â†’ Î”â€² âŠ‡ Î” â†’ Î” â Î“ âŠ¢â‚™â‚‘ A
                        â†’ Î”â€² â Î“ âŠ¢â‚™â‚‘ A
  áµrenâ‚™â‚‘ Î· (áµáµ› i)  = áµáµ› (renáµ¢ Î· i)
  áµrenâ‚™â‚‘ Î· (áµ› i )  = áµ› i
  áµrenâ‚™â‚‘ Î· (M $ N) = áµrenâ‚™â‚‘ Î· M $ áµrenâ‚™ Î· N


mutual
  renâ‚™ : âˆ€ {Î” Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î” â Î“ âŠ¢â‚™ A
                      â†’ Î” â Î“â€² âŠ¢â‚™ A
  renâ‚™ Î· (Æ› M)     = Æ› (renâ‚™ (keep Î·) M)
  renâ‚™ Î· (âŒœ M âŒ)   = âŒœ M âŒ
  renâ‚™ Î· (âŒ M âŒŸ N) = âŒ renâ‚™â‚‘ Î· M âŒŸ (renâ‚™ Î· N)
  renâ‚™ Î· (â¿áµ‰ M)    = â¿áµ‰ (renâ‚™â‚‘ Î· M)

  renâ‚™â‚‘ : âˆ€ {Î” Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î” â Î“ âŠ¢â‚™â‚‘ A
                       â†’ Î” â Î“â€² âŠ¢â‚™â‚‘ A
  renâ‚™â‚‘ Î· (áµáµ› i)  = áµáµ› i
  renâ‚™â‚‘ Î· (áµ› i)   = áµ› (renáµ¢ Î· i)
  renâ‚™â‚‘ Î· (M $ N) = renâ‚™â‚‘ Î· M $ renâ‚™ Î· N


renâ‚™Â² : âˆ€ {Î” Î”â€² Î“ Î“â€² A} â†’ Î”â€² â Î“â€² âŠ‡Â² Î” â Î“ â†’ Î” â Î“ âŠ¢â‚™ A
                        â†’ Î”â€² â Î“â€² âŠ¢â‚™ A
renâ‚™Â² Î· M = (áµrenâ‚™ (projâ‚ Î·) âˆ˜ renâ‚™ (projâ‚‚ Î·)) M

renâ‚™â‚‘Â² : âˆ€ {Î” Î”â€² Î“ Î“â€² A} â†’ Î”â€² â Î“â€² âŠ‡Â² Î” â Î“ â†’ Î” â Î“ âŠ¢â‚™â‚‘ A
                         â†’ Î”â€² â Î“â€² âŠ¢â‚™â‚‘ A
renâ‚™â‚‘Â² Î· M = (áµrenâ‚™â‚‘ (projâ‚ Î·) âˆ˜ renâ‚™â‚‘ (projâ‚‚ Î·)) M


--------------------------------------------------------------------------------
--
-- Substitution


-- Simultaneous substitutions
infix 3 _âŠ¢â‹†_
_âŠ¢â‹†_ : Cx â†’ List Tp â†’ Set
Î” â Î“ âŠ¢â‹† Î = All (Î” â Î“ âŠ¢_) Î


áµrenâ‹† : âˆ€ {Î” Î”â€² Î“ Î} â†’ Î”â€² âŠ‡ Î” â†’ Î” â Î“ âŠ¢â‹† Î
                     â†’ Î”â€² â Î“ âŠ¢â‹† Î
áµrenâ‹† Î· Ïƒ = mapAll (áµren Î·) Ïƒ

renâ‹† : âˆ€ {Î” Î“ Î“â€² Î} â†’ Î“â€² âŠ‡ Î“ â†’ Î” â Î“ âŠ¢â‹† Î
                     â†’ Î” â Î“â€² âŠ¢â‹† Î
renâ‹† Î· Ïƒ = mapAll (ren Î·) Ïƒ


áµdropâ‚› : âˆ€ {Î” Î“ Î A} â†’ Î” â Î“ âŠ¢â‹† Î
                     â†’ Î” , A â Î“ âŠ¢â‹† Î
áµdropâ‚› Ïƒ = áµrenâ‹† (drop idáµ£) Ïƒ

dropâ‚› : âˆ€ {Î” Î“ Î A} â†’ Î” â Î“ âŠ¢â‹† Î
                    â†’ Î” â Î“ , A âŠ¢â‹† Î
dropâ‚› Ïƒ = renâ‹† (drop idáµ£) Ïƒ

áµkeepâ‚› : âˆ€ {Î” Î“ Î A} â†’ Î” â Î“ âŠ¢â‹† Î
                     â†’ Î” , A â Î“ âŠ¢â‹† Î , A
áµkeepâ‚› Ïƒ = áµdropâ‚› Ïƒ , áµáµ› zero

keepâ‚› : âˆ€ {Î” Î“ Î A} â†’ Î” â Î“ âŠ¢â‹† Î
                    â†’ Î” â Î“ , A âŠ¢â‹† Î , A
keepâ‚› Ïƒ = dropâ‚› Ïƒ , áµ› zero


áµidâ‚› : âˆ€ {Î” Î“} â†’ Î” â Î“ âŠ¢â‹† Î”
áµidâ‚› {âˆ…}     = âˆ…
áµidâ‚› {Î“ , A} = áµkeepâ‚› áµidâ‚›

idâ‚› : âˆ€ {Î“ Î”} â†’ Î” â Î“ âŠ¢â‹† Î“
idâ‚› {âˆ…}     = âˆ…
idâ‚› {Î“ , A} = keepâ‚› idâ‚›


subáµ¢ : âˆ€ {Î” Î“ Î A} â†’ Î” â Î“ âŠ¢â‹† Î â†’ Î âˆ‹ A
                   â†’ Î” â Î“ âŠ¢ A
subáµ¢ Ïƒ i = lookupAll Ïƒ i


-- Substitution
áµsub : âˆ€ {Î” Î“ Î A} â†’ Î” â âˆ… âŠ¢â‹† Î â†’ Î â Î“ âŠ¢ A
                   â†’ Î” â Î“ âŠ¢ A
áµsub Ïƒ (áµáµ› i)    = ren infáµ£ (subáµ¢ Ïƒ i)
áµsub Ïƒ (áµ› i)     = áµ› i
áµsub Ïƒ (Æ› M)     = Æ› (áµsub Ïƒ M)
áµsub Ïƒ (M $ N)   = áµsub Ïƒ M $ áµsub Ïƒ N
áµsub Ïƒ âŒœ M âŒ     = âŒœ áµsub Ïƒ M âŒ
áµsub Ïƒ (âŒ M âŒŸ N) = âŒ áµsub Ïƒ M âŒŸ (áµsub (áµkeepâ‚› Ïƒ) N)

sub : âˆ€ {Î” Î“ Î A} â†’ Î” â Î“ âŠ¢â‹† Î â†’ Î” â Î âŠ¢ A
                  â†’ Î” â Î“ âŠ¢ A
sub Ïƒ (áµáµ› i)    = áµáµ› i
sub Ïƒ (áµ› i)     = subáµ¢ Ïƒ i
sub Ïƒ (Æ› M)     = Æ› (sub (keepâ‚› Ïƒ) M)
sub Ïƒ (M $ N)   = sub Ïƒ M $ sub Ïƒ N
sub Ïƒ âŒœ M âŒ     = âŒœ M âŒ
sub Ïƒ (âŒ M âŒŸ N) = âŒ sub Ïƒ M âŒŸ (sub (áµdropâ‚› Ïƒ) N)


--------------------------------------------------------------------------------
--
-- 3. Semantics


-- Definition 3.1 (Introspective Kripke models)
record ğ” : Setâ‚ where
  field
    ğ’²    : Set

    ğ’±    : ğ’² â†’ Set

    _â‰¥_  : ğ’² â†’ ğ’² â†’ Set

    idâ‚  : âˆ€ {w} â†’ w â‰¥ w

    _âˆ˜â‚_ : âˆ€ {w wâ€² wâ€³} â†’ wâ€² â‰¥ w â†’ wâ€³ â‰¥ wâ€²
                       â†’ wâ€³ â‰¥ w

    reláµ¥ : âˆ€ {w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ’± w
                    â†’ ğ’± wâ€²

    âŒŠ_âŒ‹  : ğ’² â†’ Cx

    âŒŠ_âŒ‹â‚ : âˆ€ {w wâ€²} â†’ wâ€² â‰¥ w
                    â†’ âŒŠ wâ€² âŒ‹ âŠ‡Â² âŒŠ w âŒ‹

  áµâŒŠ_âŒ‹ : ğ’² â†’ List Tp
  áµâŒŠ w âŒ‹ = projâ‚ âŒŠ w âŒ‹

  áµâŒŠ_âŒ‹â‚ : âˆ€ {w wâ€²} â†’ wâ€² â‰¥ w
                   â†’ áµâŒŠ wâ€² âŒ‹ âŠ‡ áµâŒŠ w âŒ‹
  áµâŒŠ Î· âŒ‹â‚ = projâ‚ âŒŠ Î· âŒ‹â‚

open ğ” {{...}} public


-- Definition 3.2 (Values)
mutual
  infix 3 _âˆ£_âŠ©_
  _âˆ£_âŠ©_ : âˆ€ {{ğ” : ğ”}} (ğ”â€² : ğ”) {{_ : ğ” â‰¡ ğ”â€²}} â†’ ğ’² â†’ Tp â†’ Set

  ğ” âˆ£ w âŠ© â™­     = ğ’± w

  ğ” âˆ£ w âŠ© A âŠƒ B = âˆ€ {wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ wâ€² âŠ©â‚– A
                          â†’ ğ” âˆ£ wâ€² âŠ©â‚– B

  ğ” âˆ£ w âŠ© â–¡ A   = ğ” âˆ£ w âŠ©â±¼â‚– A

  infix 3 _âˆ£_âŠ©â‚–_
  _âˆ£_âŠ©â‚–_ : âˆ€ {{ğ” : ğ”}} (ğ”â€² : ğ”) {{_ : ğ” â‰¡ ğ”â€²}} â†’ ğ’² â†’ Tp â†’ Set
  ğ” âˆ£ w âŠ©â‚– A = âˆ€ {C wâ€²} â†’ wâ€² â‰¥ w â†’ (âˆ€ {wâ€³} â†’ wâ€³ â‰¥ wâ€² â†’ ğ” âˆ£ wâ€³ âŠ© A
                                              â†’ âŒŠ wâ€³ âŒ‹ âŠ¢â‚™ C)
                         â†’ âŒŠ wâ€² âŒ‹ âŠ¢â‚™ C

  infix 3 _âˆ£_âŠ©â±¼â‚–_
  _âˆ£_âŠ©â±¼â‚–_ : âˆ€ {{ğ” : ğ”}} (ğ”â€² : ğ”) {{_ : ğ” â‰¡ ğ”â€²}} â†’ ğ’² â†’ Tp â†’ Set
  ğ” âˆ£ w âŠ©â±¼â‚– A = áµâŒŠ w âŒ‹ â âˆ… âŠ¢ A Ã— ğ” âˆ£ w âŠ©â‚– A


-- Lemma 3.3
syn : âˆ€ {{ğ” : ğ”}} {A w} â†’ ğ” âˆ£ w âŠ©â±¼â‚– A
                        â†’ áµâŒŠ w âŒ‹ â âˆ… âŠ¢ A
syn p = projâ‚ p

sem : âˆ€ {{ğ” : ğ”}} {A w} â†’ ğ” âˆ£ w âŠ©â±¼â‚– A
                        â†’ ğ” âˆ£ w âŠ©â‚– A
sem p = projâ‚‚ p


-- Lemma 3.4
mutual
  rel : âˆ€ {{ğ” : ğ”}} {A w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ w âŠ© A
                             â†’ ğ” âˆ£ wâ€² âŠ© A
  rel {â™­}     Î¾ v = reláµ¥ Î¾ v
  rel {A âŠƒ B} Î¾ f = \ Î¾â€² k â†’ f (Î¾ âˆ˜â‚ Î¾â€²) k
  rel {â–¡ A}   Î¾ p = relâ±¼â‚– Î¾ p

  relâ‚– : âˆ€ {{ğ” : ğ”}} {A w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ w âŠ©â‚– A
                              â†’ ğ” âˆ£ wâ€² âŠ©â‚– A
  relâ‚– Î¾ k = \ Î¾â€² f â†’ k (Î¾ âˆ˜â‚ Î¾â€²) f

  relâ±¼â‚– : âˆ€ {{ğ” : ğ”}} {A w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ w âŠ©â±¼â‚– A
                               â†’ ğ” âˆ£ wâ€² âŠ©â±¼â‚– A
  relâ±¼â‚– {A} Î¾ p = áµren áµâŒŠ Î¾ âŒ‹â‚ (syn p) , relâ‚– {A} Î¾ (sem p)


-- Lemma 3.5
return : âˆ€ {{ğ” : ğ”}} {A w} â†’ ğ” âˆ£ w âŠ© A
                           â†’ ğ” âˆ£ w âŠ©â‚– A
return {A} a = \ Î¾ f â†’ f idâ‚ (rel {A} Î¾ a)

bind : âˆ€ {{ğ” : ğ”}} {A C w} â†’ ğ” âˆ£ w âŠ©â‚– A â†’ (âˆ€ {wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ wâ€² âŠ© A
                                                     â†’ ğ” âˆ£ wâ€² âŠ©â‚– C)
                           â†’ ğ” âˆ£ w âŠ©â‚– C
bind k f = \ Î¾ fâ€² â†’
             k Î¾ (\ Î¾â€² a â†’
               f (Î¾ âˆ˜â‚ Î¾â€²) a idâ‚ (\ Î¾â€³ b â†’
                 fâ€² (Î¾â€² âˆ˜â‚ Î¾â€³) b))


-- Definition 3.6 (Environments)
infix 3 _âˆ£_âŠ©â‚–â‹†_
_âˆ£_âŠ©â‚–â‹†_ : âˆ€ {{ğ” : ğ”}} (ğ”â€² : ğ”) {{_ : ğ” â‰¡ ğ”â€²}} â†’ ğ’² â†’ List Tp â†’ Set
ğ” âˆ£ w âŠ©â‚–â‹† Î“ = All (ğ” âˆ£ w âŠ©â‚–_) Î“

infix 3 _âˆ£_âŠ©â±¼â‚–â‹†_
_âˆ£_âŠ©â±¼â‚–â‹†_ : âˆ€ {{ğ” : ğ”}} (ğ”â€² : ğ”) {{_ : ğ” â‰¡ ğ”â€²}} â†’ ğ’² â†’ List Tp â†’ Set
ğ” âˆ£ w âŠ©â±¼â‚–â‹† Î” = All (ğ” âˆ£ w âŠ©â±¼â‚–_) Î”


-- Lemma 3.7
synâ‹† : âˆ€ {{ğ” : ğ”}} {Î” w} â†’ ğ” âˆ£ w âŠ©â±¼â‚–â‹† Î”
                         â†’ áµâŒŠ w âŒ‹ â âˆ… âŠ¢â‹† Î”
synâ‹† Î´ = mapAll syn Î´

semâ‹† : âˆ€ {{ğ” : ğ”}} {Î” w} â†’ ğ” âˆ£ w âŠ©â±¼â‚–â‹† Î”
                         â†’ ğ” âˆ£ w âŠ©â‚–â‹† Î”
semâ‹† Î´ = mapAll sem Î´


-- Lemma 3.8
relâ‚–â‹† : âˆ€ {{ğ” : ğ”}} {Î“ w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ w âŠ©â‚–â‹† Î“
                             â†’ ğ” âˆ£ wâ€² âŠ©â‚–â‹† Î“
relâ‚–â‹† Î¾ Î³ = mapAll (\ {A} k {C} {wâ€²} â†’ relâ‚– {A} Î¾ (\ {D} {wâ€³} â†’ k {D} {wâ€³})) Î³
-- NOTE: We should be able to write this as follows:
-- relâ‚–â‹† Î¾ Î³ = mapAll (relâ‚– Î¾) Î³

relâ±¼â‚–â‹† : âˆ€ {{ğ” : ğ”}} {Î” w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ” âˆ£ w âŠ©â±¼â‚–â‹† Î”
                              â†’ ğ” âˆ£ wâ€² âŠ©â±¼â‚–â‹† Î”
relâ±¼â‚–â‹† Î¾ Î´ = mapAll (relâ±¼â‚– Î¾) Î´


-- Lemma 3.9
lookup : âˆ€ {{ğ” : ğ”}} {Î“ A w} â†’ ğ” âˆ£ w âŠ©â‚–â‹† Î“ â†’ Î“ âˆ‹ A
                             â†’ ğ” âˆ£ w âŠ©â‚– A
lookup Î³ i = lookupAll Î³ i


-- Definition 3.10 (Semantic entailment)
infix 3 _âŠ¨_
_âŠ¨_ : Cx â†’ Tp â†’ Setâ‚
Î” â Î“ âŠ¨ A = âˆ€ {{ğ” : ğ”}} {w} â†’ ğ” âˆ£ w âŠ©â±¼â‚–â‹† Î” â†’ ğ” âˆ£ w âŠ©â‚–â‹† Î“
                             â†’ ğ” âˆ£ w âŠ©â‚– A


-- Theorem 3.11 (Soundness)
â†“ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A
              â†’ Î” â Î“ âŠ¨ A
â†“ (áµáµ› i)            = \ Î´ Î³ â†’ lookup (semâ‹† Î´) i
â†“ (áµ› i)             = \ Î´ Î³ â†’ lookup Î³ i
â†“ (Æ› {A} {B} M)     = \ Î´ Î³ â†’ return {A âŠƒ B} (\ Î¾ k â†’
                        â†“ M (relâ±¼â‚–â‹† Î¾ Î´) (relâ‚–â‹† Î¾ Î³ , k))
â†“ (_$_ {A} {B} M N) = \ Î´ Î³ â†’ bind {A âŠƒ B} {B} (â†“ M Î´ Î³) (\ Î¾ f â†’
                        f idâ‚ (â†“ N (relâ±¼â‚–â‹† Î¾ Î´) (relâ‚–â‹† Î¾ Î³)))
â†“ (âŒœ_âŒ {A} M)       = \ Î´ Î³ â†’ return {â–¡ A} (áµsub (synâ‹† Î´) M , â†“ M Î´ âˆ…)
â†“ (âŒ_âŒŸ {A} {C} M N) = \ Î´ Î³ â†’ bind {â–¡ A} {C} (â†“ M Î´ Î³) (\ Î¾ p â†’
                        â†“ N (relâ±¼â‚–â‹† Î¾ Î´ , p) (relâ‚–â‹† Î¾ Î³))


-- -- --------------------------------------------------------------------------------
-- -- --
-- -- -- Completeness


-- -- -- Universal model
-- -- instance
-- --   ğ”áµ¤ : ğ”
-- --   ğ”áµ¤ = record
-- --          { ğ’²    = Cx
-- --          ; _ğ’±_  = _ğ’±áµ¤_
-- --          ; _â‰¥_  = _âŠ‡Â²_
-- --          ; idâ‚  = idáµ£Â²
-- --          ; _âˆ˜â‚_ = _âˆ˜áµ£Â²_
-- --          ; reláµ¥ = renâ‚™Â²
-- --          ; âŒŠ_âŒ‹  = id
-- --          ; âŒŠ_âŒ‹â‚ = id
-- --          }
-- --     where
-- --       infix 3 _ğ’±áµ¤_
-- --       _ğ’±áµ¤_ : Cx â†’ TVar â†’ Set
-- --       Î” â Î“ ğ’±áµ¤ x = Î” â Î“ âŠ¢â‚™ áµ—áµ› x


-- -- -- Soundness and completeness with respect to the universal model
-- -- mutual
-- --   â†“áµ¤ : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ¢â‚™â‚‘ A
-- --                  â†’ Î” â Î“ âŠ©â‚– A
-- --   â†“áµ¤ {áµ—áµ› x}  M = return {áµ—áµ› x} (â¿áµ‰ M)
-- --   â†“áµ¤ {A âŠƒ B} M = return {A âŠƒ B} (\ Î· k â†’ â†“áµ¤ (renâ‚™â‚‘Â² Î· M $ â†‘áµ¤ k))
-- --   â†“áµ¤ {A âˆ§ B} M = return {A âˆ§ B} (â†“áµ¤ (Ï€â‚ M) , â†“áµ¤ (Ï€â‚‚ M))
-- --   â†“áµ¤ {TT}    M = return {TT} tt
-- --   â†“áµ¤ {â–¡ A}   M = \ Î· f â†’ âŒ renâ‚™â‚‘Â² Î· M âŒŸ (f (áµdropÂ² idáµ£Â²) (áµáµ› zero , â†“áµ¤ (áµáµ› zero)))

-- --   â†‘áµ¤ : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ©â‚– A
-- --                  â†’ Î” â Î“ âŠ¢â‚™ A
-- --   â†‘áµ¤ {áµ—áµ› x}  k = k idáµ£Â² (\ Î· v â†’ v)
-- --   â†‘áµ¤ {A âŠƒ B} k = k idáµ£Â² (\ Î· f â†’ Æ› (â†‘áµ¤ (f (dropÂ² idáµ£Â²) (â†“áµ¤ (áµ› zero)))))
-- --   â†‘áµ¤ {A âˆ§ B} k = k idáµ£Â² (\ Î· p â†’ â†‘áµ¤ (projâ‚ p) , â†‘áµ¤ (projâ‚‚ p))
-- --   â†‘áµ¤ {TT}    k = k idáµ£Â² (\ Î· t â†’ tt)
-- --   â†‘áµ¤ {â–¡ A}   k = k idáµ£Â² (\ Î· p â†’ âŒœ syn p âŒ)


-- -- áµidâ‚‘ : âˆ€ {Î” Î“} â†’ Î” â Î“ âŠ©â±¼â‚–â‹† Î”
-- -- áµidâ‚‘ {âˆ…}     = âˆ…
-- -- áµidâ‚‘ {Î” , A} = relâ±¼â‚–â‹† (áµdropÂ² idáµ£Â²) áµidâ‚‘ , (áµáµ› zero , â†“áµ¤ (áµáµ› zero))

-- -- idâ‚‘ : âˆ€ {Î“ Î”} â†’ Î” â Î“ âŠ©â‚–â‹† Î“
-- -- idâ‚‘ {âˆ…}     = âˆ…
-- -- idâ‚‘ {Î“ , A} = relâ‚–â‹† (dropÂ² idáµ£Â²) idâ‚‘ , â†“áµ¤ (áµ› zero)


-- -- -- Completeness
-- -- â†‘ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¨ A
-- --               â†’ Î” â Î“ âŠ¢â‚™ A
-- -- â†‘ f = â†‘áµ¤ (f áµidâ‚‘ idâ‚‘)


-- -- -- Normalisation
-- -- nbe : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A
-- --                 â†’ Î” â Î“ âŠ¢â‚™ A
-- -- nbe = â†‘ âˆ˜ â†“


-- -- --------------------------------------------------------------------------------
-- -- --
-- -- -- Examples


-- -- áµáµ›0 : âˆ€ {Î” Î“ A} â†’ Î” , A â Î“ âŠ¢ A
-- -- áµáµ›0 = áµáµ› zero

-- -- áµáµ›1 : âˆ€ {Î” Î“ A B} â†’ Î” , A , B â Î“ âŠ¢ A
-- -- áµáµ›1 = áµáµ› (suc zero)

-- -- áµáµ›2 : âˆ€ {Î” Î“ A B C} â†’ Î” , A , B , C â Î“ âŠ¢ A
-- -- áµáµ›2 = áµáµ› (suc (suc zero))


-- -- áµ›0 : âˆ€ {Î” Î“ A} â†’ Î” â Î“ , A âŠ¢ A
-- -- áµ›0 = áµ› zero

-- -- áµ›1 : âˆ€ {Î” Î“ A B} â†’ Î” â Î“ , A , B âŠ¢ A
-- -- áµ›1 = áµ› (suc zero)

-- -- áµ›2 : âˆ€ {Î” Î“ A B C} â†’ Î” â Î“ , A , B , C âŠ¢ A
-- -- áµ›2 = áµ› (suc (suc zero))


-- -- áµƒË£I : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ¢ A âŠƒ A
-- -- áµƒË£I = Æ› áµ›0

-- -- áµƒË£K : âˆ€ {A B Î” Î“} â†’ Î” â Î“ âŠ¢ A âŠƒ B âŠƒ A
-- -- áµƒË£K = Æ› (Æ› áµ›1)

-- -- áµƒË£S : âˆ€ {A B C Î” Î“} â†’ Î” â Î“ âŠ¢ (A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C
-- -- áµƒË£S = Æ› (Æ› (Æ› ((áµ›2 $ áµ›0) $ (áµ›1 $ áµ›0))))


-- -- áµƒË£D : âˆ€ {A B Î” Î“} â†’ Î” â Î“ âŠ¢ â–¡ (A âŠƒ B) âŠƒ â–¡ A âŠƒ â–¡ B
-- -- áµƒË£D = Æ› (Æ› (âŒ áµ›1 âŒŸ (âŒ áµ›0 âŒŸ âŒœ áµáµ›1 $ áµáµ›0 âŒ)))

-- -- áµƒË£T : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ¢ â–¡ A âŠƒ A
-- -- áµƒË£T = Æ› (âŒ áµ›0 âŒŸ áµáµ›0)

-- -- áµƒË£4 : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ¢ â–¡ A âŠƒ â–¡ â–¡ A
-- -- áµƒË£4 = Æ› (âŒ áµ›0 âŒŸ âŒœ âŒœ áµáµ›0 âŒ âŒ)


-- -- --------------------------------------------------------------------------------
-- -- --
-- -- -- Conversion tests


-- -- testâˆ¼ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A â†’ Î” â Î“ âŠ¢ A â†’ Set
-- -- testâˆ¼ Mâ‚ Mâ‚‚ = embâ‚™ (nbe Mâ‚) â‰¡ Mâ‚‚


-- -- -- redâŠƒ : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ , A âŠ¢ B) (N : Î” â Î“ âŠ¢ A)
-- -- --                    â†’ Æ› M $ N âˆ¼ sub (idâ‚› , N) M

-- -- testâˆ¼redâŠƒ : testâˆ¼ {âˆ…} {âˆ… , "A"}
-- --                   ((Æ› áµ›0) $ áµ›0)
-- --                   áµ›0
-- -- testâˆ¼redâŠƒ = refl


-- -- -- redâˆ§â‚ : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ âŠ¢ A) (N : Î” â Î“ âŠ¢ B)
-- -- --                     â†’ Ï€â‚ (M , N) âˆ¼ M

-- -- testâˆ¼redâˆ§â‚ : testâˆ¼ {âˆ…} {âˆ… , "A" , "B"}
-- --                    (Ï€â‚ (áµ›1 , áµ›0))
-- --                    áµ›1
-- -- testâˆ¼redâˆ§â‚ = refl


-- -- -- redâˆ§â‚‚ : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ âŠ¢ A) (N : Î” â Î“ âŠ¢ B)
-- -- --                     â†’ Ï€â‚‚ (M , N) âˆ¼ N

-- -- testâˆ¼redâˆ§â‚‚ : testâˆ¼ {âˆ…} {âˆ… , "A" , "B"}
-- --                    (Ï€â‚‚ (áµ›1 , áµ›0))
-- --                    áµ›0
-- -- testâˆ¼redâˆ§â‚‚ = refl


-- -- -- redâ–¡ : âˆ€ {Î” Î“ A C} â†’ (M : Î” â âˆ… âŠ¢ A) (N : Î” , A â Î“ âŠ¢ C)
-- -- --                    â†’ âŒ âŒœ M âŒ âŒŸ N âˆ¼ áµsub (áµidâ‚› , M) N

-- -- testâˆ¼redâ–¡ : testâˆ¼ {âˆ… , "A"} {âˆ…}
-- --                   (âŒ âŒœ áµáµ›0 âŒ âŒŸ áµáµ›0)
-- --                   áµáµ›0
-- -- testâˆ¼redâ–¡ = refl


-- -- -- expâŠƒ : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ âŠ¢ A âŠƒ B)
-- -- --                    â†’ M âˆ¼ Æ› (ren (drop idáµ£) M $ áµ›0)

-- -- testâˆ¼expâŠƒ : testâˆ¼ {âˆ…} {âˆ… , "A" âŠƒ "B"}
-- --                   áµ›0
-- --                   (Æ› (ren (drop idáµ£) áµ›0 $ áµ›0))
-- -- testâˆ¼expâŠƒ = refl


-- -- -- expâˆ§ : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ âŠ¢ A âˆ§ B)
-- -- --                    â†’ M âˆ¼ Ï€â‚ M , Ï€â‚‚ M

-- -- testâˆ¼expâˆ§ : testâˆ¼ {âˆ…} {âˆ… , "A" âˆ§ "B"}
-- --                   áµ›0
-- --                   (Ï€â‚ áµ›0 , Ï€â‚‚ áµ›0)
-- -- testâˆ¼expâˆ§ = refl


-- -- -- expTT : âˆ€ {Î” Î“} â†’ (M : Î” â Î“ âŠ¢ ğ”—)
-- -- --                 â†’ M âˆ¼ tt

-- -- testâˆ¼expTT : testâˆ¼ {âˆ…} {âˆ… , TT}
-- --                    áµ›0
-- --                    tt
-- -- testâˆ¼expTT = refl


-- -- -- expâ–¡ : âˆ€ {Î” Î“} â†’ (M : Î” â Î“ âŠ¢ â–¡ A)
-- -- --                â†’ M âˆ¼ âŒ M âŒŸ âŒœ áµáµ›0 âŒ

-- -- testâˆ¼expâ–¡ : testâˆ¼ {âˆ…} {âˆ… , â–¡ "A"}
-- --                   áµ›0
-- --                   (âŒ áµ›0 âŒŸ âŒœ áµáµ›0 âŒ)
-- -- testâˆ¼expâ–¡ = refl


-- -- -- commâ–¡$ : âˆ€ {Î” Î“ A B} â†’ (ğ’¬ : Î” â Î“ âŠ¢ â–¡ (A âŠƒ B))
-- -- --                         (M : Î” , A âŠƒ B â Î“ âŠ¢ A âŠƒ B) (N : Î” â Î“ âŠ¢ A)
-- -- --                      â†’ (âŒ ğ’¬ âŒŸ M) $ N âˆ¼ âŒ ğ’¬ âŒŸ (M $ (áµren (drop idáµ£) N))

-- -- testâˆ¼commâ–¡$ : testâˆ¼ {âˆ…} {âˆ… , â–¡ ("A" âŠƒ "B") , "A"}
-- --                     ((âŒ áµ›1 âŒŸ áµáµ›0) $ áµ›0)
-- --                     (âŒ áµ›1 âŒŸ (áµáµ›0 $ áµren (drop idáµ£) áµ›0))
-- -- testâˆ¼commâ–¡$ = refl


-- -- -- commâ–¡âŒâŒŸ : âˆ€ {Î” Î“ A C} â†’ (ğ’¬ : Î” â Î“ âŠ¢ â–¡ â–¡ A)
-- -- --                          (M : Î” , â–¡ A â Î“ âŠ¢ â–¡ A) (N : Î” , A â Î“ âŠ¢ C)
-- -- --                       â†’ âŒ (âŒ ğ’¬ âŒŸ M) âŒŸ N âˆ¼ âŒ ğ’¬ âŒŸ (âŒ M âŒŸ (áµren (drop idáµ£) N))

-- -- testâˆ¼commâ–¡âŒâŒŸ : testâˆ¼ {âˆ…} {âˆ… , â–¡ â–¡ "A"}
-- --                      (âŒ âŒ áµ›0 âŒŸ áµáµ›0 âŒŸ áµáµ›0)
-- --                      (âŒ áµ›0 âŒŸ (âŒ áµáµ›0 âŒŸ áµáµ›0))
-- -- testâˆ¼commâ–¡âŒâŒŸ = refl


-- -- -- commâ–¡Ï€â‚ : âˆ€ {Î” Î“ A B} â†’ (ğ’¬ : Î” â Î“ âŠ¢ â–¡ (A âˆ§ B))
-- -- --                          (M : Î” , A âˆ§ B â Î“ âŠ¢ A âˆ§ B)
-- -- --                       â†’ Ï€â‚ (âŒ ğ’¬ âŒŸ M) âˆ¼ âŒ ğ’¬ âŒŸ (Ï€â‚ M)

-- -- testâˆ¼commâ–¡Ï€â‚ : testâˆ¼ {âˆ…} {âˆ… , â–¡ ("A" âˆ§ "B")}
-- --                      (Ï€â‚ (âŒ áµ›0 âŒŸ áµáµ›0))
-- --                      (âŒ áµ›0 âŒŸ (Ï€â‚ áµáµ›0))
-- -- testâˆ¼commâ–¡Ï€â‚ = refl


-- -- -- commâ–¡Ï€â‚‚ : âˆ€ {Î” Î“ A B} â†’ (ğ’¬ : Î” â Î“ âŠ¢ â–¡ (A âˆ§ B))
-- -- --                          (M : Î” , A âˆ§ B â Î“ âŠ¢ A âˆ§ B)
-- -- --                       â†’ Ï€â‚‚ (âŒ ğ’¬ âŒŸ M) âˆ¼ âŒ ğ’¬ âŒŸ (Ï€â‚‚ M)

-- -- testâˆ¼commâ–¡Ï€â‚‚ : testâˆ¼ {âˆ…} {âˆ… , â–¡ ("A" âˆ§ "B")}
-- --                      (Ï€â‚‚ (âŒ áµ›0 âŒŸ áµáµ›0))
-- --                      (âŒ áµ›0 âŒŸ (Ï€â‚‚ áµáµ›0))
-- -- testâˆ¼commâ–¡Ï€â‚‚ = refl


-- -- --------------------------------------------------------------------------------
-- -- --
-- -- -- Self-interpretation


-- -- -- weakBP : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ âŠ¢ A)
-- -- --                      â†’ TT $ âŒœ M âŒ âˆ¼ âŒœ M âŒ

-- -- testâˆ¼weakBP : testâˆ¼ {âˆ… , "A"} {âˆ…}
-- --                     (áµƒË£T $ âŒœ áµáµ›0 âŒ)
-- --                     áµáµ›0
-- -- testâˆ¼weakBP = refl


-- -- -- Andrej : âˆ€ {Î” Î“ A B} â†’ (M : Î” â Î“ âŠ¢ A âŠƒ B) (N : Î” â Î“ âŠ¢ A)
-- -- --                      â†’ (ğ”» $ âŒœ M âŒ) $ âŒœ N âŒ âˆ¼ âŒœ M $ N âŒ

-- -- testâˆ¼Andrej : testâˆ¼ {âˆ… , "A" âŠƒ "B" , "A"} {âˆ…}
-- --                     ((áµƒË£D $ âŒœ áµáµ›1 âŒ) $ âŒœ áµáµ›0 âŒ)
-- --                     (âŒœ áµáµ›1 $ áµáµ›0 âŒ)
-- -- testâˆ¼Andrej = refl


-- -- --------------------------------------------------------------------------------

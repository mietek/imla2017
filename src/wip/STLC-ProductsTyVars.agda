module STLC-ProductsTyVars where

open import Prelude public


--------------------------------------------------------------------------------
--
-- Syntax


-- Type variables
data TVar : Set where
  tvar : String â†’ TVar

injtvar : âˆ€ {sâ‚ sâ‚‚} â†’ tvar sâ‚ â‰¡ tvar sâ‚‚ â†’ sâ‚ â‰¡ sâ‚‚
injtvar refl = refl

_â‰Ÿâ‚œáµ¥_ : (xâ‚ xâ‚‚ : TVar) â†’ Dec (xâ‚ â‰¡ xâ‚‚)
tvar sâ‚ â‰Ÿâ‚œáµ¥ tvar sâ‚‚ = mapDec (tvar &_) injtvar (sâ‚ â‰Ÿâ‚› sâ‚‚)

instance
  tvarIsString : IsString TVar
  tvarIsString =
    record
      { Constraint = Î» s â†’ âŠ¤
      ; fromString = Î» s â†’ tvar s
      }


-- Types
infixl 9 _âˆ§_
infixr 7 _âŠƒ_
data Tp : Set where
  áµ—áµ›  : (x : TVar) â†’ Tp
  _âŠƒ_ : (A B : Tp) â†’ Tp
  _âˆ§_ : (A B : Tp) â†’ Tp
  ğ”—   : Tp

instance
  typeIsString : IsString Tp
  typeIsString =
    record
      { Constraint = Î» s â†’ âŠ¤
      ; fromString = Î» s â†’ áµ—áµ› (tvar s)
      }


-- Contexts
Cx : Set
Cx = List Tp


-- Syntactic entailment
infix 3 _âŠ¢_
data _âŠ¢_ : Cx â†’ Tp â†’ Set
  where
    áµ›   : âˆ€ {A Î“} â†’ (i : Î“ âˆ‹ A)
                  â†’ Î“ âŠ¢ A

    Æ›   : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ , A âŠ¢ B)
                    â†’ Î“ âŠ¢ A âŠƒ B

    _$_ : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢ A âŠƒ B) (â„° : Î“ âŠ¢ A)
                    â†’ Î“ âŠ¢ B

    _,_ : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢ A) (â„° : Î“ âŠ¢ B)
                    â†’ Î“ âŠ¢ A âˆ§ B

    Ï€â‚  : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢ A âˆ§ B)
                    â†’ Î“ âŠ¢ A

    Ï€â‚‚  : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢ A âˆ§ B)
                    â†’ Î“ âŠ¢ B

    tt  : âˆ€ {Î“} â†’ Î“ âŠ¢ ğ”—


-- Normal and neutral forms
mutual
  infix 3 _âŠ¢â‚™â‚˜_
  data _âŠ¢â‚™â‚˜_ : Cx â†’ Tp â†’ Set
    where
      Æ›   : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ , A âŠ¢â‚™â‚˜ B)
                      â†’ Î“ âŠ¢â‚™â‚˜ A âŠƒ B

      _,_ : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢â‚™â‚˜ A) (â„° : Î“ âŠ¢â‚™â‚˜ B)
                      â†’ Î“ âŠ¢â‚™â‚˜ A âˆ§ B

      tt  : âˆ€ {Î“} â†’ Î“ âŠ¢â‚™â‚˜ ğ”—

      â¿áµ—  : âˆ€ {x Î“} â†’ (ğ’Ÿ : Î“ âŠ¢â‚™â‚œ áµ—áµ› x)
                    â†’ Î“ âŠ¢â‚™â‚˜ áµ—áµ› x

  infix 3 _âŠ¢â‚™â‚œ_
  data _âŠ¢â‚™â‚œ_ : Cx â†’ Tp â†’ Set
    where
      áµ›   : âˆ€ {A Î“} â†’ (i : Î“ âˆ‹ A)
                    â†’ Î“ âŠ¢â‚™â‚œ A

      _$_ : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢â‚™â‚œ A âŠƒ B) (â„° : Î“ âŠ¢â‚™â‚˜ A)
                      â†’ Î“ âŠ¢â‚™â‚œ B

      Ï€â‚  : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢â‚™â‚œ A âˆ§ B)
                      â†’ Î“ âŠ¢â‚™â‚œ A

      Ï€â‚‚  : âˆ€ {A B Î“} â†’ (ğ’Ÿ : Î“ âŠ¢â‚™â‚œ A âˆ§ B)
                      â†’ Î“ âŠ¢â‚™â‚œ B


mutual
  embâ‚™â‚˜ : âˆ€ {Î“ A} â†’ Î“ âŠ¢â‚™â‚˜ A â†’ Î“ âŠ¢ A
  embâ‚™â‚˜ (Æ› ğ’Ÿ)   = Æ› (embâ‚™â‚˜ ğ’Ÿ)
  embâ‚™â‚˜ (ğ’Ÿ , â„°) = embâ‚™â‚˜ ğ’Ÿ , embâ‚™â‚˜ â„°
  embâ‚™â‚˜ tt      = tt
  embâ‚™â‚˜ (â¿áµ— ğ’Ÿ)  = embâ‚™â‚œ ğ’Ÿ

  embâ‚™â‚œ : âˆ€ {Î“ A} â†’ Î“ âŠ¢â‚™â‚œ A â†’ Î“ âŠ¢ A
  embâ‚™â‚œ (áµ› i)   = áµ› i
  embâ‚™â‚œ (ğ’Ÿ $ â„°) = embâ‚™â‚œ ğ’Ÿ $ embâ‚™â‚˜ â„°
  embâ‚™â‚œ (Ï€â‚ ğ’Ÿ)  = Ï€â‚ (embâ‚™â‚œ ğ’Ÿ)
  embâ‚™â‚œ (Ï€â‚‚ ğ’Ÿ)  = Ï€â‚‚ (embâ‚™â‚œ ğ’Ÿ)


--------------------------------------------------------------------------------
--
-- Renaming


ren : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢ A
                 â†’ Î“â€² âŠ¢ A
ren Î· (áµ› i)   = áµ› (lookupáµ£ Î· i)
ren Î· (Æ› ğ’Ÿ)   = Æ› (ren (lift Î·) ğ’Ÿ)
ren Î· (ğ’Ÿ $ â„°) = ren Î· ğ’Ÿ $ ren Î· â„°
ren Î· (ğ’Ÿ , â„°) = ren Î· ğ’Ÿ , ren Î· â„°
ren Î· (Ï€â‚ ğ’Ÿ)  = Ï€â‚ (ren Î· ğ’Ÿ)
ren Î· (Ï€â‚‚ ğ’Ÿ)  = Ï€â‚‚ (ren Î· ğ’Ÿ)
ren Î· tt      = tt


mutual
  renâ‚™â‚˜ : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢â‚™â‚˜ A
                     â†’ Î“â€² âŠ¢â‚™â‚˜ A
  renâ‚™â‚˜ Î· (Æ› ğ’Ÿ)   = Æ› (renâ‚™â‚˜ (lift Î·) ğ’Ÿ)
  renâ‚™â‚˜ Î· (ğ’Ÿ , â„°) = renâ‚™â‚˜ Î· ğ’Ÿ , renâ‚™â‚˜ Î· â„°
  renâ‚™â‚˜ Î· tt      = tt
  renâ‚™â‚˜ Î· (â¿áµ— ğ’Ÿ)  = â¿áµ— (renâ‚™â‚œ Î· ğ’Ÿ)

  renâ‚™â‚œ : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢â‚™â‚œ A
                     â†’ Î“â€² âŠ¢â‚™â‚œ A
  renâ‚™â‚œ Î· (áµ› i)   = áµ› (lookupáµ£ Î· i)
  renâ‚™â‚œ Î· (ğ’Ÿ $ â„°) = renâ‚™â‚œ Î· ğ’Ÿ $ renâ‚™â‚˜ Î· â„°
  renâ‚™â‚œ Î· (Ï€â‚ ğ’Ÿ)  = Ï€â‚ (renâ‚™â‚œ Î· ğ’Ÿ)
  renâ‚™â‚œ Î· (Ï€â‚‚ ğ’Ÿ)  = Ï€â‚‚ (renâ‚™â‚œ Î· ğ’Ÿ)


--------------------------------------------------------------------------------
--
-- Substitution


{-
-- Simultaneous substitutions
infix 3 _âŠ¢â‹†_
_âŠ¢â‹†_ : Cx â†’ List Tp â†’ Set
Î“ âŠ¢â‹† Î = All (Î“ âŠ¢_) Î


renâ‹† : âˆ€ {Î“ Î“â€² Î} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢â‹† Î
                  â†’ Î“â€² âŠ¢â‹† Î
renâ‹† Î· Ïƒ = mapâ‚ (ren Î·) Ïƒ


wkâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î
                â†’ Î“ , A âŠ¢â‹† Î
wkâ‚› Ïƒ = renâ‹† (wk idáµ£) Ïƒ

liftâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î
                  â†’ Î“ , A âŠ¢â‹† Î , A
liftâ‚› Ïƒ = wkâ‚› Ïƒ , áµ› zero


idâ‚› : âˆ€ {Î“} â†’ Î“ âŠ¢â‹† Î“
idâ‚› {âˆ…}     = âˆ…
idâ‚› {Î“ , A} = liftâ‚› idâ‚›


lookupâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ Î âˆ‹ A
                    â†’ Î“ âŠ¢ A
lookupâ‚› Ïƒ i = lookupâ‚ Ïƒ i


-- Substitution
sub : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ Î âŠ¢ A
                â†’ Î“ âŠ¢ A
sub Ïƒ (áµ› i)   = lookupâ‚› Ïƒ i
sub Ïƒ (Æ› ğ’Ÿ)   = Æ› (sub (liftâ‚› Ïƒ) ğ’Ÿ)
sub Ïƒ (ğ’Ÿ $ â„°) = sub Ïƒ ğ’Ÿ $ sub Ïƒ â„°
sub Î· (ğ’Ÿ , â„°) = sub Î· ğ’Ÿ , sub Î· â„°
sub Î· (Ï€â‚ ğ’Ÿ)  = Ï€â‚ (sub Î· ğ’Ÿ)
sub Î· (Ï€â‚‚ ğ’Ÿ)  = Ï€â‚‚ (sub Î· ğ’Ÿ)
sub Î· tt      = tt
-}


--------------------------------------------------------------------------------
--
-- Semantics


-- Kripke models
record ğ” : Setâ‚ where
  field
    ğ’²    : Set

    _ğ’±_  : ğ’² â†’ TVar â†’ Set

    _â‰¥_  : ğ’² â†’ ğ’² â†’ Set

    idâ‚  : âˆ€ {w} â†’ w â‰¥ w

    _âˆ˜â‚_ : âˆ€ {w wâ€² wâ€³} â†’ wâ€² â‰¥ w â†’ wâ€³ â‰¥ wâ€²
                       â†’ wâ€³ â‰¥ w

    mováµ¥ : âˆ€ {x w wâ€²} â†’ wâ€² â‰¥ w â†’ w ğ’± x
                      â†’ wâ€² ğ’± x

open ğ” {{â€¦}} public


-- Values
infix 3 _âŠ©_
_âŠ©_ : âˆ€ {{ğ” : ğ”}} â†’ ğ’² â†’ Tp â†’ Set

w âŠ© áµ—áµ› x  = w ğ’± x

w âŠ© A âŠƒ B = âˆ€ {wâ€²} â†’ (Î· : wâ€² â‰¥ w) (k : wâ€² âŠ© A)
                    â†’ wâ€² âŠ© B

w âŠ© A âˆ§ B = w âŠ© A Ã— w âŠ© B

w âŠ© ğ”—     = âŠ¤


-- Environments
infix 3 _âŠ©â‹†_
_âŠ©â‹†_ : âˆ€ {{ğ” : ğ”}} â†’ ğ’² â†’ List Tp â†’ Set
w âŠ©â‹† Î = All (w âŠ©_) Î


-- Semantic entailment
infix 3 _âŠ¨_
_âŠ¨_ : Cx â†’ Tp â†’ Setâ‚
Î“ âŠ¨ A = âˆ€ {{ğ” : ğ”}} {w} â†’ w âŠ©â‹† Î“
                         â†’ w âŠ© A


-- Accessibility
mov : âˆ€ {{ğ” : ğ”}} {A w wâ€²} â†’ wâ€² â‰¥ w â†’ w âŠ© A
                           â†’ wâ€² âŠ© A
mov {áµ—áµ› x}  Î· v = mováµ¥ Î· v
mov {A âŠƒ B} Î· f = Î» Î·â€² â†’ f (Î· âˆ˜â‚ Î·â€²)
mov {A âˆ§ B} Î· p = mov {A} Î· (projâ‚ p) , mov {B} Î· (projâ‚‚ p)
mov {ğ”—}     Î· t = tt

movâ‹† : âˆ€ {{ğ” : ğ”}} {Î w wâ€²} â†’ wâ€² â‰¥ w â†’ w âŠ©â‹† Î
                            â†’ wâ€² âŠ©â‹† Î
movâ‹† Î· Î³ = mapâ‚ (Î» {A} â†’ mov {A} Î·) Î³


lookup : âˆ€ {{ğ” : ğ”}} {Î A w} â†’ w âŠ©â‹† Î â†’ Î âˆ‹ A
                             â†’ w âŠ© A
lookup Î³ i = lookupâ‚ Î³ i


-- Soundness
â†“ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A
            â†’ Î“ âŠ¨ A
â†“ (áµ› i)   = Î» Î³ â†’ lookup Î³ i
â†“ (Æ› ğ’Ÿ)   = Î» Î³ Î· a â†’ â†“ ğ’Ÿ (movâ‹† Î· Î³ , a)
â†“ (ğ’Ÿ $ â„°) = Î» Î³ â†’ â†“ ğ’Ÿ Î³ idâ‚ (â†“ â„° Î³)
â†“ (ğ’Ÿ , â„°) = Î» Î³ â†’ â†“ ğ’Ÿ Î³ , â†“ â„° Î³
â†“ (Ï€â‚ ğ’Ÿ)  = Î» Î³ â†’ projâ‚ (â†“ ğ’Ÿ Î³)
â†“ (Ï€â‚‚ ğ’Ÿ)  = Î» Î³ â†’ projâ‚‚ (â†“ ğ’Ÿ Î³)
â†“ tt      = Î» Î³ â†’ tt


--------------------------------------------------------------------------------
--
-- Completeness


-- Universal model
instance
  ğ”áµ¤ : ğ”
  ğ”áµ¤ = record
         { ğ’²    = Cx
         ; _ğ’±_  = _ğ’±áµ¤_
         ; _â‰¥_  = _âŠ‡_
         ; idâ‚  = idáµ£
         ; _âˆ˜â‚_ = _âˆ˜áµ£_
         ; mováµ¥ = renâ‚™â‚˜
         }
    where
      infix 3 _ğ’±áµ¤_
      _ğ’±áµ¤_ : Cx â†’ TVar â†’ Set
      Î“ ğ’±áµ¤ x = Î“ âŠ¢â‚™â‚˜ áµ—áµ› x


-- Soundness and completeness with respect to the universal model
mutual
  â†“áµ¤ : âˆ€ {A Î“} â†’ Î“ âŠ¢â‚™â‚œ A
               â†’ Î“ âŠ© A
  â†“áµ¤ {áµ—áµ› x}  ğ’Ÿ = â¿áµ— ğ’Ÿ
  â†“áµ¤ {A âŠƒ B} ğ’Ÿ = Î» Î· k â†’ â†“áµ¤ (renâ‚™â‚œ Î· ğ’Ÿ $ â†‘áµ¤ k)
  â†“áµ¤ {A âˆ§ B} ğ’Ÿ = â†“áµ¤ (Ï€â‚ ğ’Ÿ) , â†“áµ¤ (Ï€â‚‚ ğ’Ÿ)
  â†“áµ¤ {ğ”—}     ğ’Ÿ = tt

  â†‘áµ¤ : âˆ€ {A Î“} â†’ Î“ âŠ© A
               â†’ Î“ âŠ¢â‚™â‚˜ A
  â†‘áµ¤ {áµ—áµ› x}  v = v
  â†‘áµ¤ {A âŠƒ B} f = Æ› (â†‘áµ¤ (f (wk idáµ£) (â†“áµ¤ {A} (áµ› zero))))
  â†‘áµ¤ {A âˆ§ B} p = â†‘áµ¤ (projâ‚ p) , â†‘áµ¤ (projâ‚‚ p)
  â†‘áµ¤ {ğ”—}     t = tt


idâ‚‘ : âˆ€ {Î“} â†’ Î“ âŠ©â‹† Î“
idâ‚‘ {âˆ…}     = âˆ…
idâ‚‘ {Î“ , A} = movâ‹† (wk idáµ£) idâ‚‘ , â†“áµ¤ {A} (áµ› zero)


-- Completeness
â†‘ : âˆ€ {Î“ A} â†’ Î“ âŠ¨ A
            â†’ Î“ âŠ¢â‚™â‚˜ A
â†‘ f = â†‘áµ¤ (f idâ‚‘)


-- Normalisation
nm : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A
             â†’ Î“ âŠ¢â‚™â‚˜ A
nm = â†‘ âˆ˜ â†“


--------------------------------------------------------------------------------
--
-- Examples


áµ›0 : âˆ€ {Î“ A} â†’ Î“ , A âŠ¢ A
áµ›0 = áµ› zero

áµ›1 : âˆ€ {Î“ A B} â†’ Î“ , A , B âŠ¢ A
áµ›1 = áµ› (suc zero)

áµ›2 : âˆ€ {Î“ A B C} â†’ Î“ , A , B , C âŠ¢ A
áµ›2 = áµ› (suc (suc zero))


áµƒË£I : âˆ€ {A Î“} â†’ Î“ âŠ¢ A âŠƒ A
áµƒË£I = Æ› áµ›0

áµƒË£K : âˆ€ {A B Î“} â†’ Î“ âŠ¢ A âŠƒ B âŠƒ A
áµƒË£K = Æ› (Æ› áµ›1)

áµƒË£S : âˆ€ {A B C Î“} â†’ Î“ âŠ¢ (A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C
áµƒË£S = Æ› (Æ› (Æ› ((áµ›2 $ áµ›0) $ (áµ›1 $ áµ›0))))


--------------------------------------------------------------------------------
--
-- Conversion tests


testâˆ¼ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢ A â†’ Set
testâˆ¼ ğ’Ÿâ‚ ğ’Ÿâ‚‚ = embâ‚™â‚˜ (nm ğ’Ÿâ‚) â‰¡ ğ’Ÿâ‚‚


-- redâŠƒ : âˆ€ {Î“ A B} â†’ (ğ’Ÿ : Î“ , A âŠ¢ B) (â„° : Î“ âŠ¢ A)
--                  â†’ Æ› ğ’Ÿ $ â„° âˆ¼ sub (idâ‚› , â„°) ğ’Ÿ

testâˆ¼redâŠƒ : testâˆ¼ {âˆ… , "A"}
                  ((Æ› áµ›0) $ áµ›0)
                  áµ›0
testâˆ¼redâŠƒ = refl


-- redâˆ§â‚ : âˆ€ {Î“ A B} â†’ (ğ’Ÿ : Î“ âŠ¢ A) (â„° : Î“ âŠ¢ B)
--                   â†’ Ï€â‚ (ğ’Ÿ , â„°) âˆ¼ ğ’Ÿ

testâˆ¼redâˆ§â‚ : testâˆ¼ {âˆ… , "A" , "B"}
                   (Ï€â‚ (áµ›1 , áµ›0))
                   áµ›1
testâˆ¼redâˆ§â‚ = refl


-- redâˆ§â‚‚ : âˆ€ {Î“ A B} â†’ (ğ’Ÿ : Î“ âŠ¢ A) (â„° : Î“ âŠ¢ B)
--                   â†’ Ï€â‚‚ (ğ’Ÿ , â„°) âˆ¼ â„°

testâˆ¼redâˆ§â‚‚ : testâˆ¼ {âˆ… , "A" , "B"}
                   (Ï€â‚‚ (áµ›1 , áµ›0))
                   áµ›0
testâˆ¼redâˆ§â‚‚ = refl


-- expâŠƒ : âˆ€ {Î“ A B} â†’ (ğ’Ÿ : Î“ âŠ¢ A âŠƒ B)
--                  â†’ ğ’Ÿ âˆ¼ Æ› (ren (wk idáµ£) ğ’Ÿ $ áµ›0)

testâˆ¼expâŠƒ : testâˆ¼ {âˆ… , "A" âŠƒ "B"}
                  áµ›0
                  (Æ› (ren (wk idáµ£) áµ›0 $ áµ›0))
testâˆ¼expâŠƒ = refl


-- expâˆ§ : âˆ€ {Î“ A B} â†’ (ğ’Ÿ : Î“ âŠ¢ A âˆ§ B)
--                  â†’ ğ’Ÿ âˆ¼ Ï€â‚ ğ’Ÿ , Ï€â‚‚ ğ’Ÿ

testâˆ¼expâˆ§ : testâˆ¼ {âˆ… , "A" âˆ§ "B"}
                  áµ›0
                  (Ï€â‚ áµ›0 , Ï€â‚‚ áµ›0)
testâˆ¼expâˆ§ = refl


-- expğ”— : âˆ€ {Î“} â†’ (ğ’Ÿ : Î“ âŠ¢ ğ”—)
--              â†’ ğ’Ÿ âˆ¼ tt

testâˆ¼expğ”— : testâˆ¼ {âˆ… , ğ”—}
                  áµ›0
                  tt
testâˆ¼expğ”— = refl


--------------------------------------------------------------------------------

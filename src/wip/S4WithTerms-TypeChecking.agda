module S4WithTerms-TypeChecking where

open import S4WithTerms public


--------------------------------------------------------------------------------
--
-- Bidirectional type checking


-- Bidirectional syntactic entailment
mutual
  infix 3 _Ріб_РЄљ_
  data _Ріб_РЄљ_ : ­Юњъ Рєњ Term Рєњ ­Юњ» Рєњ Set
    where
      кЏ_РѕЎ_   : Рѕђ {A B M ╬ћ ╬Њ} Рєњ (x : RVar) (­ЮњЪ : ╬ћ РЂЈ ╬Њ , (x , A) Ріб M РЄљ B)
                             Рєњ ╬ћ РЂЈ ╬Њ Ріб кЏ x РѕЎ M РЄљ A РіЃ B

      _,_    : Рѕђ {A B M N ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄљ A) (Рё░ : ╬ћ РЂЈ ╬Њ Ріб N РЄљ B)
                               Рєњ ╬ћ РЂЈ ╬Њ Ріб M , N РЄљ A РѕД B

      tt     : Рѕђ {╬ћ ╬Њ} Рєњ ╬ћ РЂЈ ╬Њ Ріб tt РЄљ ­ЮЋІ

      Рїю_РїЮ    : Рѕђ {A M ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ РѕЁ Ріб M РЄљ A)
                           Рєњ ╬ћ РЂЈ ╬Њ Ріб Рїю M РїЮ РЄљ РќА A

      Рїъ_РїЪ_РѕЎ_ : Рѕђ {A C M N ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄњ РќА A) (x : MVar) (Рё░ : ╬ћ , (x , A) РЂЈ ╬Њ Ріб N РЄљ C)
                               Рєњ ╬ћ РЂЈ ╬Њ Ріб Рїъ M РїЪ x РѕЎ N РЄљ C

      РЂ┐рхЌ     : Рѕђ {x M ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄњ рхЌрхЏ x)
                           Рєњ ╬ћ РЂЈ ╬Њ Ріб M РЄљ рхЌрхЏ x

  infix 3 _Ріб_РЄњ_
  data _Ріб_РЄњ_ : ­Юњъ Рєњ Term Рєњ ­Юњ» Рєњ Set
    where
      рхљрхЏ_#_ : Рѕђ {A ╬ћ ╬Њ} Рєњ (x : MVar) (i : ╬ћ РѕІ (x , A))
                        Рєњ ╬ћ РЂЈ ╬Њ Ріб рхљрхЏ x РЄњ A

      ╩│рхЏ_#_ : Рѕђ {A ╬ћ ╬Њ} Рєњ (x : RVar) (i : ╬Њ РѕІ (x , A))
                        Рєњ ╬ћ РЂЈ ╬Њ Ріб ╩│рхЏ x РЄњ A

      _$_   : Рѕђ {A B M N ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄњ A РіЃ B) (Рё░ : ╬ћ РЂЈ ╬Њ Ріб N РЄљ A)
                              Рєњ ╬ћ РЂЈ ╬Њ Ріб M $ N РЄњ B

      ¤ђРѓЂ    : Рѕђ {A B M ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄњ A РѕД B)
                            Рєњ ╬ћ РЂЈ ╬Њ Ріб ¤ђРѓЂ M РЄњ A

      ¤ђРѓѓ    : Рѕђ {A B M ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄњ A РѕД B)
                            Рєњ ╬ћ РЂЈ ╬Њ Ріб ¤ђРѓѓ M РЄњ B

      _Рдѓ_   : Рѕђ {A M ╬ћ ╬Њ} Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄљ A) (AРђ▓ : ­Юњ») {{_ : A РЅА AРђ▓}}
                          Рєњ ╬ћ РЂЈ ╬Њ Ріб M Рдѓ A РЄњ A


рхљрхЏ0РѓЎРѓю : Рѕђ {A ╬ћ ╬Њ} Рєњ (x : MVar) Рєњ ╬ћ , (x , A) РЂЈ ╬Њ Ріб рхљрхЏ x РЄњ A
рхљрхЏ0РѓЎРѓю x = рхљрхЏ x # zero

рхљрхЏ1РѓЎРѓю : Рѕђ {A yB ╬ћ ╬Њ} Рєњ (x : MVar) Рєњ ╬ћ , (x , A) , yB РЂЈ ╬Њ Ріб рхљрхЏ x РЄњ A
рхљрхЏ1РѓЎРѓю x = рхљрхЏ x # suc zero

рхљрхЏ2РѓЎРѓю : Рѕђ {A yB zC ╬ћ ╬Њ} Рєњ (x : MVar) Рєњ ╬ћ , (x , A) , yB , zC РЂЈ ╬Њ Ріб рхљрхЏ x РЄњ A
рхљрхЏ2РѓЎРѓю x = рхљрхЏ x # suc (suc zero)


╩│рхЏ0РѓЎРѓю : Рѕђ {A ╬ћ ╬Њ} Рєњ (x : RVar) Рєњ ╬ћ РЂЈ ╬Њ , (x , A) Ріб ╩│рхЏ x РЄњ A
╩│рхЏ0РѓЎРѓю x = ╩│рхЏ x # zero

╩│рхЏ1РѓЎРѓю : Рѕђ {A yB ╬ћ ╬Њ} Рєњ (x : RVar) Рєњ ╬ћ РЂЈ ╬Њ , (x , A) , yB Ріб ╩│рхЏ x РЄњ A
╩│рхЏ1РѓЎРѓю x = ╩│рхЏ x # suc zero

╩│рхЏ2РѓЎРѓю : Рѕђ {A yB zC ╬ћ ╬Њ} Рєњ (x : RVar) Рєњ ╬ћ РЂЈ ╬Њ , (x , A) , yB , zC Ріб ╩│рхЏ x РЄњ A
╩│рхЏ2РѓЎРѓю x = ╩│рхЏ x # suc (suc zero)


mfind : (╬ћ : List (MVar ├Ќ ­Юњ»)) (x : MVar) Рєњ String Ріј ╬Б ­Юњ» (╬╗ A Рєњ ╬ћ РѕІ (x , A))
mfind РѕЁ              x = injРѓЂ "mfind|РѕЁ"
mfind (╬ћ , (xРђ▓ , A)) x with x РЅЪРѓўрхЦ xРђ▓
Рђд                     | yes refl = injРѓѓ (A , zero)
Рђд                     | no xРЅбy   = forРіј (mfind ╬ћ x)
                                      (_РД║ " mfind|,")
                                      (map╬Б id suc)


rfind : (╬Њ : List (RVar ├Ќ ­Юњ»)) (x : RVar) Рєњ String Ріј ╬Б ­Юњ» (╬╗ A Рєњ ╬Њ РѕІ (x , A))
rfind РѕЁ              x = injРѓЂ "rfind|РѕЁ"
rfind (╬Њ , (xРђ▓ , A)) x with x РЅЪрхБрхЦ xРђ▓
Рђд                     | yes refl = injРѓѓ (A , zero)
Рђд                     | no xРЅбy   = forРіј (rfind ╬Њ x)
                                      (_РД║ " rfind|,")
                                      (map╬Б id suc)


-- Type checking and type synthesis
mutual
  check : Рѕђ {╬ћ ╬Њ} M A Рєњ String Ріј ╬ћ РЂЈ ╬Њ Ріб M РЄљ A

  check M@(рхљрхЏ _)                  A       = switch M A

  check M@(╩│рхЏ _)                  A       = switch M A

  check (кЏ _ РѕЎ _)                 (рхЌрхЏ _)  = injРѓЂ "check|кЏ|рхЌрхЏ"
  check {╬Њ = ╬Њ} (кЏ x РѕЎ M)         (A РіЃ B) = forРіј (check {╬Њ = ╬Њ , (x , A)} M B)
                                              ("check|кЏ|РіЃ " РД║_)
                                              (кЏ x РѕЎ_)
  check (кЏ _ РѕЎ _)                 (_ РѕД _) = injРѓЂ "check|кЏ|РѕД"
  check (кЏ _ РѕЎ _)                 ­ЮЋІ       = injРѓЂ "check|кЏ|­ЮЋІ"
  check (кЏ _ РѕЎ _)                 (РќА _)   = injРѓЂ "check|кЏ|РќА"

  check M@(_ $ _)                 A       = switch M A

  check (_ , _)                   (рхЌрхЏ _)  = injРѓЂ "check|,|рхЌрхЏ"
  check (_ , _)                   (_ РіЃ _) = injРѓЂ "check|,|РіЃ"
  check (M , N)                   (A РѕД B) = elimРіј (check M A)
                                              (╬╗ s Рєњ injРѓЂ ("check|,|РѕД|1 " РД║ s))
                                              (╬╗ ­ЮњЪ Рєњ forРіј (check N B)
                                                        ("check|,|РѕД|2 " РД║_)
                                                        (­ЮњЪ ,_))
  check (_ , _)                   ­ЮЋІ       = injРѓЂ "check|,|­ЮЋІ"
  check (_ , _)                   (РќА _)   = injРѓЂ "check|,|РќА"

  check M@(¤ђРѓЂ _)                  A       = switch M A

  check M@(¤ђРѓѓ _)                  A       = switch M A

  check tt                        (рхЌрхЏ _)  = injРѓЂ "check|tt|рхЌрхЏ"
  check tt                        (_ РіЃ _) = injРѓЂ "check|tt|РіЃ"
  check tt                        (_ РѕД _) = injРѓЂ "check|tt|РѕД"
  check tt                        ­ЮЋІ       = injРѓѓ tt
  check tt                        (РќА _)   = injРѓЂ "check|tt|РќА"

  check Рїю _ РїЮ                     (рхЌрхЏ _)  = injРѓЂ "check|РїюРїЮ|рхЌрхЏ"
  check Рїю _ РїЮ                     (_ РіЃ _) = injРѓЂ "check|РїюРїЮ|РіЃ"
  check Рїю _ РїЮ                     (_ РѕД _) = injРѓЂ "check|РїюРїЮ|РѕД"
  check Рїю _ РїЮ                     ­ЮЋІ       = injРѓЂ "check|РїюРїЮ|­ЮЋІ"
  check Рїю M РїЮ                     (РќА A)   = forРіј (check {╬Њ = РѕЁ} M A)
                                              ("check|РїюРїЮ|РќА " РД║_)
                                              Рїю_РїЮ

  check {╬ћ = ╬ћ} {╬Њ} (Рїъ M РїЪ x РѕЎ N) C       = elimРіј (synth {╬ћ = ╬ћ} {╬Њ} M)
                                              (╬╗ s Рєњ injРѓЂ ("check|РїъРїЪ|0 " РД║ s))
                                              (╬╗ { (рхЌрхЏ x  , ­ЮњЪ) Рєњ injРѓЂ "check|РїъРїЪ|рхЌрхЏ"
                                                 ; (A РіЃ B , ­ЮњЪ) Рєњ injРѓЂ "check|РїъРїЪ|РіЃ"
                                                 ; (A РѕД B , ­ЮњЪ) Рєњ injРѓЂ "check|РїъРїЪ|РѕД"
                                                 ; (­ЮЋІ     , ­ЮњЪ) Рєњ injРѓЂ "check|РїъРїЪ|­ЮЋІ"
                                                 ; (РќА A   , ­ЮњЪ) Рєњ forРіј (check {╬ћ = ╬ћ , (x , A)} N C)
                                                                    ("check|РїъРїЪ|2 " РД║_)
                                                                    (Рїъ ­ЮњЪ РїЪ x РѕЎ_)
                                                 })

  check M@(_ Рдѓ _)                 A       = switch M A


  switch : Рѕђ {╬ћ ╬Њ} M A Рєњ String Ріј ╬ћ РЂЈ ╬Њ Ріб M РЄљ A
  switch M (рхЌрхЏ x)  = elimРіј (synth M)
                       (╬╗ s Рєњ injРѓЂ ("switch|рхЌрхЏ|0 " РД║ s) )
                       (╬╗ { (рхЌрхЏ y , ­ЮњЪ) Рєњ case x РЅЪРѓюрхЦ y of
                                            (╬╗ { (yes refl) Рєњ injРѓѓ (РЂ┐рхЌ ­ЮњЪ)
                                               ; (no xРЅбy)   Рєњ injРѓЂ "switch|рхЌрхЏ|РЅб"
                                               })
                          ; (_ РіЃ _ , ­ЮњЪ) Рєњ injРѓЂ "switch|рхЌрхЏ|РіЃ"
                          ; (_ РѕД _ , ­ЮњЪ) Рєњ injРѓЂ "switch|рхЌрхЏ|РѕД"
                          ; (­ЮЋІ     , ­ЮњЪ) Рєњ injРѓЂ "switch|рхЌрхЏ|­ЮЋІ"
                          ; (РќА _   , ­ЮњЪ) Рєњ injРѓЂ "switch|рхЌрхЏ|РќА"
                          })
  switch M (_ РіЃ _) = injРѓЂ "switch|РіЃ"
  switch M (_ РѕД _) = injРѓЂ "switch|РѕД"
  switch M ­ЮЋІ       = injРѓЂ "switch|­ЮЋІ"
  switch M (РќА _)   = injРѓЂ "switch|РќА"


  synth : Рѕђ {╬ћ ╬Њ} M Рєњ String Ріј ╬Б ­Юњ» (╬╗ A Рєњ ╬ћ РЂЈ ╬Њ Ріб M РЄњ A)

  synth {╬ћ = ╬ћ} (рхљрхЏ x) = forРіј (mfind ╬ћ x)
                           ("synth|рхљрхЏ " РД║_)
                           (map╬Б id (рхљрхЏ x #_))

  synth {╬Њ = ╬Њ} (╩│рхЏ x) = forРіј (rfind ╬Њ x)
                           ("synth|╩│рхЏ " РД║_)
                           (map╬Б id (╩│рхЏ x #_))

  synth (кЏ _ РѕЎ _)      = injРѓЂ "synth|кЏ"

  synth (M $ N)        = elimРіј (synth M)
                           (╬╗ s Рєњ injРѓЂ ("synth|$|0 " РД║ s))
                           (╬╗ { (рхЌрхЏ _  , ­ЮњЪ) Рєњ injРѓЂ "synth|$|рхЌрхЏ"
                              ; (A РіЃ B , ­ЮњЪ) Рєњ forРіј (check N A)
                                                 ("synth|$|РіЃ " РД║_)
                                                 (╬╗ Рё░ Рєњ B , ­ЮњЪ $ Рё░)
                              ; (_ РѕД _ , ­ЮњЪ) Рєњ injРѓЂ "synth|$|РѕД"
                              ; (­ЮЋІ     , ­ЮњЪ) Рєњ injРѓЂ "synth|$|­ЮЋІ"
                              ; (РќА _   , ­ЮњЪ) Рєњ injРѓЂ "synth|$|РќА"
                              })

  synth (_ , _)        = injРѓЂ "synth|,"

  synth (¤ђРѓЂ M)         = elimРіј (synth M)
                           (╬╗ s Рєњ injРѓЂ ("synth|¤ђРѓЂ|0 " РД║ s))
                           (╬╗ { (рхЌрхЏ _  , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|рхЌрхЏ"
                              ; (_ РіЃ _ , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|РіЃ"
                              ; (A РѕД B , ­ЮњЪ) Рєњ injРѓѓ (A , ¤ђРѓЂ ­ЮњЪ)
                              ; (­ЮЋІ     , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|­ЮЋІ"
                              ; (РќА _   , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|РќА"
                              })

  synth (¤ђРѓѓ M)         = elimРіј (synth M)
                           (╬╗ s Рєњ injРѓЂ ("synth|¤ђРѓЂ|0 " РД║ s))
                           (╬╗ { (рхЌрхЏ _  , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|рхЌрхЏ"
                              ; (_ РіЃ _ , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|РіЃ"
                              ; (A РѕД B , ­ЮњЪ) Рєњ injРѓѓ (B , ¤ђРѓѓ ­ЮњЪ)
                              ; (­ЮЋІ     , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|­ЮЋІ"
                              ; (РќА _   , ­ЮњЪ) Рєњ injРѓЂ "synth|¤ђРѓЂ|РќА"
                              })

  synth tt             = injРѓЂ "synth|tt"

  synth Рїю _ РїЮ          = injРѓЂ "synth|РїюРїЮ"

  synth (Рїъ _ РїЪ _ РѕЎ _)  = injРѓЂ "synth|РїъРїЪ"

  synth (M Рдѓ A)        = forРіј (check M A)
                           ("synth|Рдѓ " РД║_)
                           (╬╗ ­ЮњЪ Рєњ A , ­ЮњЪ Рдѓ A)


--------------------------------------------------------------------------------
--
-- Type checking tests


testРЄљ : Рѕђ {╬ћ ╬Њ} M A Рєњ (­ЮњЪ : ╬ћ РЂЈ ╬Њ Ріб M РЄљ A) Рєњ Set
testРЄљ M A ­ЮњЪ = check M A РЅА injРѓѓ ­ЮњЪ


testРЄљaxI : testРЄљ {РѕЁ} {РѕЁ}
                   (кЏ "x" РѕЎ ╩│рхЏ "x")
                   ("A" РіЃ "A")
                   (кЏ "x" РѕЎ РЂ┐рхЌ (╩│рхЏ0РѓЎРѓю "x"))
testРЄљaxI = refl


testРЄљaxK : testРЄљ {РѕЁ} {РѕЁ}
                   (кЏ "x" РѕЎ (кЏ "y" РѕЎ ╩│рхЏ "x"))
                   ("A" РіЃ "B" РіЃ "A")
                   (кЏ "x" РѕЎ (кЏ "y" РѕЎ РЂ┐рхЌ (╩│рхЏ1РѓЎРѓю "x")))
testРЄљaxK = refl


testРЄљaxS : testРЄљ {РѕЁ} {РѕЁ}
                   (кЏ "f" РѕЎ (кЏ "g" РѕЎ (кЏ "x" РѕЎ
                     ((╩│рхЏ "f" $ ╩│рхЏ "x") $ (╩│рхЏ "g" $ ╩│рхЏ "x")))))
                   (("A" РіЃ "B" РіЃ "C") РіЃ ("A" РіЃ "B") РіЃ "A" РіЃ "C")
                   (кЏ "f" РѕЎ (кЏ "g" РѕЎ (кЏ "x" РѕЎ
                     РЂ┐рхЌ ((╩│рхЏ2РѓЎРѓю "f" $ РЂ┐рхЌ (╩│рхЏ0РѓЎРѓю "x")) $ РЂ┐рхЌ (╩│рхЏ1РѓЎРѓю "g" $ РЂ┐рхЌ (╩│рхЏ0РѓЎРѓю "x"))))))
testРЄљaxS = refl


testРЄљaxD : testРЄљ {РѕЁ} {РѕЁ}
                   (кЏ "'f" РѕЎ (кЏ "'x" РѕЎ
                     (Рїъ ╩│рхЏ "'f" РїЪ "f" РѕЎ (Рїъ ╩│рхЏ "'x" РїЪ "x" РѕЎ
                       Рїю рхљрхЏ "f" $ рхљрхЏ "x" РїЮ))))
                   (РќА ("A" РіЃ "B") РіЃ РќА "A" РіЃ РќА "B")
                   (кЏ "'f" РѕЎ (кЏ "'x" РѕЎ
                     (Рїъ ╩│рхЏ1РѓЎРѓю "'f" РїЪ "f" РѕЎ (Рїъ ╩│рхЏ0РѓЎРѓю "'x" РїЪ "x" РѕЎ
                       Рїю РЂ┐рхЌ (рхљрхЏ1РѓЎРѓю "f" $ РЂ┐рхЌ (рхљрхЏ0РѓЎРѓю "x")) РїЮ))))
testРЄљaxD = refl


testРЄљaxT : testРЄљ {РѕЁ} {РѕЁ}
                   (кЏ "'x" РѕЎ (Рїъ ╩│рхЏ "'x" РїЪ "x" РѕЎ рхљрхЏ "x"))
                   (РќА "A" РіЃ "A")
                   (кЏ "'x" РѕЎ (Рїъ ╩│рхЏ0РѓЎРѓю "'x" РїЪ "x" РѕЎ РЂ┐рхЌ (рхљрхЏ0РѓЎРѓю "x")))
testРЄљaxT = refl


testРЄљax4 : testРЄљ {РѕЁ} {РѕЁ}
                   (кЏ "'x" РѕЎ (Рїъ ╩│рхЏ "'x" РїЪ "x" РѕЎ Рїю Рїю рхљрхЏ "x" РїЮ РїЮ))
                   (РќА "A" РіЃ РќА РќА "A")
                   (кЏ "'x" РѕЎ (Рїъ ╩│рхЏ0РѓЎРѓю "'x" РїЪ "x" РѕЎ Рїю Рїю РЂ┐рхЌ (рхљрхЏ0РѓЎРѓю "x") РїЮ РїЮ))
testРЄљax4 = refl


--------------------------------------------------------------------------------

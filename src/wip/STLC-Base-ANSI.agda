module STLC-Base-ANSI where

open import Prelude


--------------------------------------------------------------------------------
--
-- Syntax


-- Types
infixr 7 _â‡’_
data Type : Set
  where
    â€¢    : Type
    _â‡’_ : Type â†’ Type â†’ Type


-- Contexts
Context : Set
Context = List Type


-- Terms, or syntactic entailment
infix 3 _âŠ¢_
data _âŠ¢_ : Context â†’ Type â†’ Set
  where
    var : âˆ€ {A Î“} â†’ Î“ âˆ‹ A
                  ---------
                  â†’ Î“ âŠ¢ A

    lam : âˆ€ {A B Î“} â†’ Î“ , A âŠ¢ B
                    --------------
                    â†’ Î“ âŠ¢ A â‡’ B

    _$_ : âˆ€ {A B Î“} â†’ Î“ âŠ¢ A â‡’ B â†’ Î“ âŠ¢ A
                    ------------------------
                    â†’ Î“ âŠ¢ B


mutual
  -- Terms in normal form
  infix 3 _âŠ¢â‚™â‚˜_
  data _âŠ¢â‚™â‚˜_ : Context â†’ Type â†’ Set
    where
      lam : âˆ€ {A B Î“} â†’ Î“ , A âŠ¢â‚™â‚˜ B
                      ----------------
                      â†’ Î“ âŠ¢â‚™â‚˜ A â‡’ B

      nt  : âˆ€ {Î“} â†’ Î“ âŠ¢â‚™â‚œ â€¢
                  -----------
                  â†’ Î“ âŠ¢â‚™â‚˜ â€¢

  -- Terms in neutral form
  infix 3 _âŠ¢â‚™â‚œ_
  data _âŠ¢â‚™â‚œ_ : Context â†’ Type â†’ Set
    where
      var : âˆ€ {A Î“} â†’ Î“ âˆ‹ A
                    -----------
                    â†’ Î“ âŠ¢â‚™â‚œ A

      _$_ : âˆ€ {A B Î“} â†’ Î“ âŠ¢â‚™â‚œ A â‡’ B â†’ Î“ âŠ¢â‚™â‚˜ A
                      ----------------------------
                      â†’ Î“ âŠ¢â‚™â‚œ B


mutual
  embâ‚™â‚˜ : âˆ€ {Î“ A} â†’ Î“ âŠ¢â‚™â‚˜ A
                  -----------
                  â†’ Î“ âŠ¢ A

  embâ‚™â‚˜ (lam M) = lam (embâ‚™â‚˜ M)
  embâ‚™â‚˜ (nt M)  = embâ‚™â‚œ M


  embâ‚™â‚œ : âˆ€ {Î“ A} â†’ Î“ âŠ¢â‚™â‚œ A
                  -----------
                  â†’ Î“ âŠ¢ A

  embâ‚™â‚œ (var i) = var i
  embâ‚™â‚œ (M $ N) = embâ‚™â‚œ M $ embâ‚™â‚˜ N


--------------------------------------------------------------------------------
--
-- Renaming


ren : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢ A
                 -------------------
                 â†’ Î“â€² âŠ¢ A

ren Î· (var i) = var (lookupáµ£ Î· i)
ren Î· (lam M) = lam (ren (lift Î·) M)
ren Î· (M $ N) = ren Î· M $ ren Î· N


mutual
  renâ‚™â‚˜ : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢â‚™â‚˜ A
                     ---------------------
                     â†’ Î“â€² âŠ¢â‚™â‚˜ A

  renâ‚™â‚˜ Î· (lam M) = lam (renâ‚™â‚˜ (lift Î·) M)
  renâ‚™â‚˜ Î· (nt M)  = nt (renâ‚™â‚œ Î· M)


  renâ‚™â‚œ : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ¢â‚™â‚œ A
                     ---------------------
                     â†’ Î“â€² âŠ¢â‚™â‚œ A

  renâ‚™â‚œ Î· (var i) = var (lookupáµ£ Î· i)
  renâ‚™â‚œ Î· (M $ N) = renâ‚™â‚œ Î· M $ renâ‚™â‚˜ Î· N


--------------------------------------------------------------------------------
--
-- Semantics


-- Kripke models
record ğ” : Setâ‚ where
  field
    ğ’²    : Set

    ğ’±    : ğ’² â†’ Set

    _â‰¥_  : ğ’² â†’ ğ’² â†’ Set

    idâ‚  : âˆ€ {w} â†’ w â‰¥ w

    _âˆ˜â‚_ : âˆ€ {w wâ€² wâ€³} â†’ wâ€² â‰¥ w â†’ wâ€³ â‰¥ wâ€²
                       --------------------
                       â†’ wâ€³ â‰¥ w

    mováµ¥ : âˆ€ {w wâ€²} â†’ wâ€² â‰¥ w â†’ ğ’± w
                    ----------------
                    â†’ ğ’± wâ€²

open ğ” {{â€¦}} public


-- Values
infix 3 _âŠ©_
_âŠ©_ : âˆ€ {{ğ” : ğ”}} â†’ ğ’² â†’ Type â†’ Set

w âŠ© â€¢      = ğ’± w

w âŠ© A â‡’ B = âˆ€ {wâ€²} â†’ (Î· : wâ€² â‰¥ w) (k : wâ€² âŠ© A)
                     â†’ wâ€² âŠ© B


-- Environments
infix 3 _âŠ©â‹†_
_âŠ©â‹†_ : âˆ€ {{ğ” : ğ”}} â†’ ğ’² â†’ List Type â†’ Set
w âŠ©â‹† âˆ…     = âŠ¤
w âŠ©â‹† Î“ , A = w âŠ©â‹† Î“ Ã— w âŠ© A


-- Semantic entailment
infix 3 _âŠ¨_
_âŠ¨_ : Context â†’ Type â†’ Setâ‚
Î“ âŠ¨ A = âˆ€ {{ğ” : ğ”}} {w} â†’ w âŠ©â‹† Î“
                         â†’ w âŠ© A


-- Accessibility
mov : âˆ€ {{ğ” : ğ”}} {A w wâ€²} â†’ wâ€² â‰¥ w â†’ w âŠ© A
                           -------------------
                           â†’ wâ€² âŠ© A
mov {â€¢}      Î· v = mováµ¥ Î· v
mov {A â‡’ B} Î· f = Î» Î·â€² â†’ f (Î· âˆ˜â‚ Î·â€²)


movâ‹† : âˆ€ {{ğ” : ğ”}} {Î“ w wâ€²} â†’ wâ€² â‰¥ w â†’ w âŠ©â‹† Î“
                            --------------------
                            â†’ wâ€² âŠ©â‹† Î“

movâ‹† {Î“ = âˆ…}     Î· tt      = tt
movâ‹† {Î“ = Î“ , A} Î· (Î³ , a) = movâ‹† Î· Î³ , mov {A} Î· a


lookup : âˆ€ {{ğ” : ğ”}} {Î“ A w} â†’ w âŠ©â‹† Î“ â†’ Î“ âˆ‹ A
                             -------------------
                             â†’ w âŠ© A

lookup {Î“ = âˆ…}     tt      ()
lookup {Î“ = Î“ , A} (Î³ , a) zero    = a
lookup {Î“ = Î“ , B} (Î³ , b) (suc i) = lookup Î³ i


-- Soundness
â†“ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A
            ---------
            â†’ Î“ âŠ¨ A

â†“ (var i) = Î» Î³ â†’ lookup Î³ i
â†“ (lam M) = Î» Î³ Î· a â†’ â†“ M (movâ‹† Î· Î³ , a)
â†“ (M $ N) = Î» Î³ â†’ (â†“ M Î³) idâ‚ (â†“ N Î³)


--------------------------------------------------------------------------------
--
-- Completeness


-- Universal model
instance
  ğ”áµ¤ : ğ”
  ğ”áµ¤ = record
         { ğ’²    = Context
         ; ğ’±    = _âŠ¢â‚™â‚˜ â€¢
         ; _â‰¥_  = _âŠ‡_
         ; idâ‚  = idáµ£
         ; _âˆ˜â‚_ = _âˆ˜áµ£_
         ; mováµ¥ = renâ‚™â‚˜
         }


-- Soundness and completeness with respect to the universal model
mutual
  â†“áµ¤ : âˆ€ {A Î“} â†’ Î“ âŠ¢â‚™â‚œ A
               â†’ Î“ âŠ© A
  â†“áµ¤ {â€¢}      M = nt M
  â†“áµ¤ {A â‡’ B} M = Î» Î· a â†’ â†“áµ¤ (renâ‚™â‚œ Î· M $ â†‘áµ¤ a)

  â†‘áµ¤ : âˆ€ {A Î“} â†’ Î“ âŠ© A
               â†’ Î“ âŠ¢â‚™â‚˜ A
  â†‘áµ¤ {â€¢}      v = v
  â†‘áµ¤ {A â‡’ B} f = lam (â†‘áµ¤ (f (wk idáµ£) (â†“áµ¤ {A} (var zero))))


idâ‚‘ : âˆ€ {Î“} â†’ Î“ âŠ©â‹† Î“
idâ‚‘ {âˆ…}     = tt
idâ‚‘ {Î“ , A} = movâ‹† (wk idáµ£) idâ‚‘ , â†“áµ¤ {A} (var zero)


-- Completeness
â†‘ : âˆ€ {Î“ A} â†’ Î“ âŠ¨ A
            â†’ Î“ âŠ¢â‚™â‚˜ A
â†‘ f = â†‘áµ¤ (f idâ‚‘)


-- Normalisation
nm : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A
             â†’ Î“ âŠ¢â‚™â‚˜ A
nm = â†‘ âˆ˜ â†“



--------------------------------------------------------------------------------
--
-- Examples


v0 : âˆ€ {Î“ A} â†’ Î“ , A âŠ¢ A
v0 = var zero

v1 : âˆ€ {Î“ A B} â†’ Î“ , A , B âŠ¢ A
v1 = var (suc zero)

v2 : âˆ€ {Î“ A B C} â†’ Î“ , A , B , C âŠ¢ A
v2 = var (suc (suc zero))


áµƒË£I : âˆ€ {A Î“} â†’ Î“ âŠ¢ A â‡’ A
áµƒË£I = lam v0

áµƒË£K : âˆ€ {A B Î“} â†’ Î“ âŠ¢ A â‡’ B â‡’ A
áµƒË£K = lam (lam v1)

áµƒË£S : âˆ€ {A B C Î“} â†’ Î“ âŠ¢ (A â‡’ B â‡’ C) â‡’ (A â‡’ B) â‡’ A â‡’ C
áµƒË£S = lam (lam (lam ((v2 $ v0) $ (v1 $ v0))))


--------------------------------------------------------------------------------
--
-- Conversion tests


testâˆ¼ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢ A â†’ Set
testâˆ¼ Mâ‚ Mâ‚‚ = embâ‚™â‚˜ (nm Mâ‚) â‰¡ Mâ‚‚


-- redâ‡’ : âˆ€ {Î“ A B} â†’ (M : Î“ , A âŠ¢ B) (N : Î“ âŠ¢ A)
--                  â†’ lam M $ N âˆ¼ sub (idâ‚› , N) M

testâˆ¼redâ‡’ : testâˆ¼ {âˆ… , â€¢}
                   ((lam v0) $ v0)
                   v0
testâˆ¼redâ‡’ = refl


-- expâ‡’ : âˆ€ {Î“ A B} â†’ (M : Î“ âŠ¢ A â‡’ B)
--                  â†’ M âˆ¼ lam (ren (wk idáµ£) M $ v0)

testâˆ¼expâ‡’ : testâˆ¼ {âˆ… , â€¢ â‡’ â€¢}
                   v0
                   (lam (ren (wk idáµ£) v0 $ v0))
testâˆ¼expâ‡’ = refl


--------------------------------------------------------------------------------
